<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPI - Content Planner Indonesia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 
        Chosen Palette: Modern Neutrals with Vibrant Accents. Background: bg-stone-50. Main text: text-stone-800. Accents for status: Teal (Ide), Sky (Draf), Amber (Dikerjakan), Rose (Review), Indigo (Terjadwal), Green (Terpublikasi), Orange (Revisi). Chart colors are refined with softer, modern tones.
        Application Structure Plan: An SPA with an initial login/signup page and a main app view. The main app is tab-based with navigation for "Kalender", "Laporan", and "Pengaturan". This structure logically separates core functionalities. Role-Based Access Control (RBAC) is implemented to tailor the user experience. The "Laporan" view integrates KPI cards, dynamic charts, and an AI-simulated analytical insights section. Content management is handled via a modal, which now includes detailed, platform-specific metrics and a status history. This design prioritizes an intuitive, modern, and scalable user flow, ready for backend integration.
        Visualization & Content Choices: 
        - Report Info: Authentication -> Goal: Secure/Organize -> Viz: Login/Signup page with RBAC. Justification: Secures app access and creates user roles.
        - Report Info: Monthly Performance -> Goal: Analyze -> Viz: Tabbed interface for primary navigation. Justification: Clear separation of distinct user tasks.
        - Report Info: Platform-Specific Metrics -> Goal: Inform/Compare -> Viz: Dynamic form fields per platform within the content modal and platform-filtered charts on the report page. Justification: Enables granular data input and analysis.
        - Report Info: Content Details (Description, Status History, Files, Links) -> Goal: Organize/Track -> Viz: Enhanced content modal with structured fields. Justification: Adds crucial detail, audit trail, and asset management placeholders.
        - Report Info: Calendar View -> Goal: Organize/Plan -> Viz: Grid and List view options. Justification: Provides user choice for visual planning.
        - Report Info: AI Analysis -> Goal: Synthesize/Advise -> Viz: Dynamically generated text block based on report data. Justification: Provides expert analysis and actionable recommendations.
        - Design Enhancements: iOS-like modern aesthetics, larger title, right-aligned nav, footer credit.
        All visualizations are built with standard HTML/JS and styled with Tailwind. Charting is handled by Chart.js.
        CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; transition: background-color 0.3s ease, color 0.3s ease; }
        body.dark-mode { background-color: #1a202c; color: #e2e8f0; }
        body.dark-mode .text-stone-800 { color: #e2e8f0; }
        body.dark-mode .text-stone-900 { color: #f8fafc; }
        body.dark-mode .text-stone-500 { color: #a0aec0; }
        body.dark-mode .bg-white { background-color: #2d3748; }
        body.dark-mode .bg-stone-50 { background-color: #2d3748; }
        body.dark-mode .bg-stone-100 { background-color: #4a5568; }
        body.dark-mode .border-stone-200 { border-color: #4a5568; }
        body.dark-mode .border-stone-300 { border-color: #4a5568; }
        body.dark-mode .hover\:bg-stone-100:hover { background-color: #4a5568; }
        body.dark-mode .hover\:bg-stone-200:hover { background-color: #4a5568; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark-mode input::placeholder, body.dark-mode textarea::placeholder { color: #a0aec0; }
        body.dark-mode .modal-backdrop { background-color: rgba(0,0,0,0.7); }
        body.dark-mode .nav-btn:not(.active) { color: #a0aec0; }
        body.dark-mode .nav-btn:not(.active):hover { background-color: #4a5568; }


        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .day-cell { min-height: 120px; }
        @media (max-width: 768px) { .day-cell { min-height: 90px; } }
        .platform-icon {
            width: 24px;
            height: 24px;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: white;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        .nav-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .nav-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .nav-btn:not(.active) {
            background-color: transparent;
            color: #57534e; /* stone-600 */
        }
         .nav-btn:not(.active):hover {
            background-color: #e7e5e4; /* stone-200 */
         }

        .settings-sidebar-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .settings-sidebar-btn.active {
            background-color: #e0e7ff; /* indigo-100 */
            color: #4f46e5; /* indigo-600 */
        }
        body.dark-mode .settings-sidebar-btn.active {
            background-color: #4338ca; /* indigo-700 */
            color: #e0e7ff;
        }
        .settings-sidebar-btn:not(.active):hover {
            background-color: #f5f5f4; /* stone-100 */
        }
        body.dark-mode .settings-sidebar-btn:not(.active):hover {
            background-color: #4a5568;
        }

        /* Custom confirmation modal */
        .custom-confirm-modal {
            background-color: rgba(0,0,0,0.5);
        }
        .custom-confirm-modal-content {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            padding: 1.5rem;
        }
        body.dark-mode .custom-confirm-modal-content {
            background-color: #2d3748;
        }

        .status-history-item {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-history-item span:first-child {
            font-weight: 500;
        }
        .status-history-item span:last-child {
            color: #71717a; /* stone-500 */
        }
        .member-color-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        /* Styles for the iOS-like list view */
        .ios-list-item {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .ios-list-item:hover {
            background-color: #f5f5f5;
        }
        body.dark-mode .ios-list-item {
            background-color: #2d3748;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        body.dark-mode .ios-list-item:hover {
            background-color: #4a5568;
        }
        .ios-list-date {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4f46e5; /* Indigo 600 */
            flex-shrink: 0;
            width: 50px; /* Fixed width for date */
            text-align: center;
        }
        body.dark-mode .ios-list-date {
            color: #e0e7ff; /* Indigo 100 */
        }
        .ios-list-title {
            font-weight: 500;
            color: #1f2937;
            flex-grow: 1;
        }
        body.dark-mode .ios-list-title {
            color: #e2e8f0;
        }
        .ios-list-status {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            flex-shrink: 0;
        }
        .ios-list-pic {
            font-size: 0.75rem;
            color: #6b7280;
            flex-shrink: 0;
        }

        /* Profile Picture Style */
        .profile-picture-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e0e7ff; /* light indigo border */
        }

        /* Platform specific metric inputs */
        .platform-metrics-group {
            border: 1px solid #e7e5e4; /* stone-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 0.75rem;
            background-color: #fafaf9; /* stone-50 */
        }
        body.dark-mode .platform-metrics-group {
            border-color: #4a5568;
            background-color: #2d3748;
        }
        /* Login Page Styles */
        .login-container {
            display: flex;
            flex-direction: column; /* Changed to column for header */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f8fafc;
        }
        body.dark-mode .login-container {
            background-color: #1a202c;
        }
        .login-card {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 400px;
        }
        body.dark-mode .login-card {
            background-color: #2d3748;
        }
        .login-header { /* New style for login page header */
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-header img {
            margin: 0 auto 10px auto;
        }
        .login-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e7e5e4; /* stone-200 */
        }
        .login-tab-btn {
            flex-grow: 1;
            padding: 0.75rem 0;
            text-align: center;
            font-weight: 600;
            color: #71717a; /* stone-500 */
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .login-tab-btn.active {
            color: #4f46e5; /* indigo-600 */
            border-color: #4f46e5;
        }
        body.dark-mode .login-tab-btn {
            color: #a0aec0;
        }
        body.dark-mode .login-tab-btn.active {
            color: #e0e7ff;
            border-color: #e0e7ff;
        }
    </style>
</head>
<body class="text-stone-800">

    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-header">
            <img id="login-company-logo-display" src="https://placehold.co/60x60/E0E7FF/4F46E5?text=Logo" alt="Company Logo" class="w-16 h-16 rounded-full object-cover">
            <h1 class="text-4xl font-bold text-stone-900">Content Planner</h1>
            <p id="login-company-name-display" class="text-stone-500">Perencanaan dan analisis konten bulanan untuk kreator Indonesia.</p>
        </div>
        <div class="login-card">
            <div class="login-tabs">
                <button id="login-tab-btn" class="login-tab-btn active">Login</button>
                <button id="signup-tab-btn" class="login-tab-btn">Daftar</button>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="text-sm font-medium text-stone-700 block mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="email@example.com" required>
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-stone-700 block mb-1">Kata Sandi</label>
                    <input type="password" id="login-password" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="********" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">Login</button>
                <p id="login-error-message" class="text-red-600 text-sm text-center hidden">Email atau kata sandi salah.</p>
                <p class="text-center text-sm text-stone-500 mt-4">
                    <a href="#" id="forgot-password-link" class="text-indigo-600 hover:underline">Lupa Kata Sandi?</a> (simulasi)
                </p>
            </form>

            <form id="signup-form" class="space-y-4 hidden">
                <div>
                    <label for="signup-name" class="text-sm font-medium text-stone-700 block mb-1">Nama Lengkap</label>
                    <input type="text" id="signup-name" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="Nama Anda" required>
                </div>
                <div>
                    <label for="signup-email" class="text-sm font-medium text-stone-700 block mb-1">Email</label>
                    <input type="email" id="signup-email" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="email@example.com" required>
                </div>
                <div>
                    <label for="signup-password" class="text-sm font-medium text-stone-700 block mb-1">Buat Kata Sandi</label>
                    <input type="password" id="signup-password" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="********" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">Daftar Akun Baru</button>
                <p class="text-center text-sm text-stone-500 mt-4">
                    Sudah punya akun? <a href="#" id="login-link-from-signup" class="text-indigo-600 hover:underline">Login di sini</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="app" class="p-4 md:p-8 max-w-7xl mx-auto hidden">

        <!-- Header -->
        <header class="mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center gap-4">
                    <img id="company-logo-display" src="https://placehold.co/40x40/E0E7FF/4F46E5?text=Logo" alt="Company Logo" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <h1 class="text-4xl font-bold text-stone-900">Content Planner</h1>
                        <p id="company-name-display" class="text-stone-500">Perencanaan dan analisis konten bulanan untuk kreator Indonesia.</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <nav class="flex items-center gap-2 p-1 bg-stone-100 rounded-lg">
                        <button id="nav-calendar" class="nav-btn active">🗓️ Kalender</button>
                        <button id="nav-report" class="nav-btn">📊 Laporan</button>
                        <button id="nav-settings" class="nav-btn">⚙️ Pengaturan</button>
                    </nav>
                    <button id="add-new-content-btn" class="bg-indigo-600 text-white font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">
                        Tambah Konten
                    </button>
                    <button id="logout-btn" class="bg-red-500 text-white font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-red-600 transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main>
            <!-- Calendar View -->
            <div id="calendar-view">
                <div class="flex flex-col lg:flex-row gap-6">
                    <div class="w-full lg:flex-grow">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
                            <div class="flex items-center gap-4">
                                <button id="prev-month-cal" class="p-2 rounded-md hover:bg-stone-200 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <h2 id="month-year-cal" class="text-xl font-semibold text-center w-48"></h2>
                                <button id="next-month-cal" class="p-2 rounded-md hover:bg-stone-200 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-2 flex-wrap">
                                <select id="filter-platform" class="bg-white border border-stone-300 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500">
                                    <option value="all">Semua Platform</option>
                                </select>
                                <select id="filter-status" class="bg-white border border-stone-300 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500">
                                    <option value="all">Semua Status</option>
                                </select>
                                <div class="flex items-center gap-1 p-1 bg-stone-100 rounded-lg">
                                    <button id="view-calendar-grid" class="nav-btn active !px-3 !py-1.5 !text-sm">Grid</button>
                                    <button id="view-calendar-list" class="nav-btn !px-3 !py-1.5 !text-sm">Daftar</button>
                                </div>
                            </div>
                        </div>
                        <div id="calendar-grid-view-container" class="bg-white rounded-lg shadow-sm p-4">
                            <div class="calendar-grid border-b border-l border-stone-200">
                                <div class="text-center font-medium text-xs text-stone-500 py-2 border-t border-r border-stone-200">MIN</div>
                                <div class="text-center font-medium text-xs text-stone-500 py-2 border-t border-r border-stone-200">SEN</div>
                                <div class="text-center font-medium text-xs text-stone-500 py-2 border-t border-r border-stone-200">SEL</div>
                                <div class="text-center font-medium text-xs text-stone-500 py-2 border-t border-r border-stone-200">RAB</div>
                                <div class="text-center font-medium text-xs text-stone-500 py-2 border-t border-r border-stone-200">KAM</div>
                                <div class="text-center font-medium text-xs text-stone-500 py-2 border-t border-r border-stone-200">JUM</div>
                                <div class="text-center font-medium text-xs text-stone-500 py-2 border-t border-r border-stone-200">SAB</div>
                            </div>
                            <div id="calendar-body" class="calendar-grid"></div>
                        </div>
                        <div id="calendar-list-view-container" class="hidden bg-white rounded-lg shadow-sm p-4 mt-4">
                            <h3 class="text-xl font-semibold mb-4 text-stone-900">Konten Mendatang</h3>
                            <div id="calendar-list-body" class="space-y-2">
                                <!-- List items will be populated here -->
                            </div>
                        </div>
                    </div>
                    <aside class="w-full lg:w-72 lg:flex-shrink-0">
                        <div class="bg-white rounded-lg shadow-sm p-4">
                            <h3 class="font-bold mb-3 text-stone-900">💡 Inspirasi Lokal</h3>
                            <div id="local-inspiration-content" class="space-y-3"></div>
                        </div>
                    </aside>
                </div>
            </div>

            <!-- Report View -->
            <div id="report-view" class="hidden">
                <div class="bg-white rounded-lg shadow-sm p-4 md:p-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-stone-900">Laporan Insight Bulanan</h2>
                         <div class="flex items-center gap-2">
                             <select id="report-month" class="bg-white border border-stone-300 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500"></select>
                             <select id="report-year" class="bg-white border border-stone-300 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500"></select>
                             <!-- New Platform Filter for Report -->
                             <select id="report-platform-filter" class="bg-white border border-stone-300 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500">
                                 <option value="all">Semua Platform</option>
                             </select>
                         </div>
                    </div>
                    
                    <!-- Summary Stats -->
                    <p class="text-sm text-stone-600 mb-4">Berikut adalah ringkasan performa konten Anda yang dipublikasikan pada bulan yang dipilih. Metrik ini membantu Anda memahami dampak dari upaya kreatif Anda secara keseluruhan.</p>
                    <div id="summary-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <!-- Stat cards will be populated by JS -->
                    </div>
                    
                    <!-- Charts -->
                    <div class="space-y-12">
                        <div>
                            <h3 class="text-xl font-semibold mb-1 text-stone-800">Performa Engagement per Platform</h3>
                            <p class="text-sm text-stone-600 mb-4">Grafik ini membandingkan total engagement (likes + komentar + save + share) untuk setiap platform, membantu Anda mengidentifikasi platform mana yang paling efektif dalam mendorong interaksi audiens.</p>
                            <div class="chart-container">
                                <canvas id="platform-performance-chart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-1 text-stone-800">Performa Konten Individual</h3>
                             <p class="text-sm text-stone-600 mb-4">Lacak performa (berdasarkan jumlah likes) dari setiap konten yang dipublikasikan selama bulan ini. Ini membantu menemukan konten mana yang menjadi bintang dan mana yang kurang berhasil.</p>
                            <div class="chart-container">
                                <canvas id="content-performance-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Qualitative Insights -->
                    <div class="mt-12">
                        <h3 class="text-xl font-semibold mb-1 text-stone-800">Analisis & Rekomendasi</h3>
                        <p class="text-sm text-stone-600 mb-4">Sebagai analis media sosial profesional, berikut adalah insight dan saran berdasarkan data performa bulan ini:</p>
                        <div id="analytical-insights-output" class="bg-stone-100 p-4 rounded-lg text-sm text-stone-700 leading-relaxed">
                            <!-- Dynamic analysis will be inserted here -->
                        </div>
                        <div class="flex flex-wrap justify-end items-center pt-4 gap-2">
                            <button type="button" id="print-report-btn" class="bg-stone-200 text-stone-700 font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-stone-300 transition-colors">Cetak Laporan</button>
                            <button type="button" id="export-pdf-report-btn" class="bg-stone-200 text-stone-700 font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-stone-300 transition-colors">Ekspor PDF Laporan</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden">
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Settings Sidebar -->
                    <aside class="w-full lg:w-64 lg:flex-shrink-0">
                        <div class="bg-white rounded-lg shadow-sm p-4 space-y-2">
                            <button id="settings-nav-account" class="settings-sidebar-btn active">Akun</button>
                            <button id="settings-nav-company" class="settings-sidebar-btn">Perusahaan</button>
                            <button id="settings-nav-team" class="settings-sidebar-btn">Manajemen Tim</button>
                            <button id="settings-nav-display" class="settings-sidebar-btn">Tampilan</button>
                        </div>
                    </aside>

                    <!-- Settings Content -->
                    <div class="w-full lg:flex-grow bg-white rounded-lg shadow-sm p-4 md:p-6">
                        <!-- Account Settings -->
                        <div id="settings-content-account" class="settings-content-pane">
                            <h3 class="text-xl font-semibold mb-4 text-stone-900">Pengaturan Akun</h3>
                            <form id="account-settings-form" class="space-y-4">
                                <div>
                                    <label for="account-name" class="text-sm font-medium text-stone-700 block mb-1">Nama Pengguna</label>
                                    <input type="text" id="account-name" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" value="Nama Pengguna">
                                </div>
                                <!-- Profile Picture Upload -->
                                <div>
                                    <label for="profile-picture-upload" class="text-sm font-medium text-stone-700 block mb-1">Foto Profil</label>
                                    <div class="flex items-center gap-4">
                                        <img id="profile-picture-preview" src="https://placehold.co/80x80/E0E7FF/4F46E5?text=PP" alt="Profile Picture Preview" class="profile-picture-preview">
                                        <input type="file" id="profile-picture-upload" accept="image/*" class="w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                    </div>
                                    <p class="text-xs text-stone-500 mt-1">Unggah gambar profil Anda (maks. 1MB).</p>
                                </div>
                                <div>
                                    <label for="account-email" class="text-sm font-medium text-stone-700 block mb-1">Email</label>
                                    <input type="email" id="account-email" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" value="pengguna@example.com" disabled>
                                </div>
                                <div>
                                    <label for="account-password" class="text-sm font-medium text-stone-700 block mb-1">Kata Sandi Baru</label>
                                    <input type="password" id="account-password" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="Biarkan kosong jika tidak ingin mengubah">
                                </div>
                                <button type="submit" class="bg-indigo-600 text-white font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">Simpan Perubahan</button>
                            </form>
                        </div>

                        <!-- Company Settings -->
                        <div id="settings-content-company" class="settings-content-pane hidden">
                            <h3 class="text-xl font-semibold mb-4 text-stone-900">Pengaturan Perusahaan</h3>
                            <form id="company-settings-form" class="space-y-4">
                                <div>
                                    <label for="company-name" class="text-sm font-medium text-stone-700 block mb-1">Nama Perusahaan</label>
                                    <input type="text" id="company-name" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <!-- Logo Input -->
                                <div>
                                    <label for="company-logo-upload" class="text-sm font-medium text-stone-700 block mb-1">Logo Perusahaan</label>
                                    <div class="flex items-center gap-4">
                                        <img id="company-logo-preview" src="https://placehold.co/60x60/E0E7FF/4F46E5?text=Logo" alt="Logo Preview" class="w-16 h-16 rounded-full object-cover border border-stone-200">
                                        <input type="file" id="company-logo-upload" accept="image/*" class="w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                    </div>
                                    <p class="text-xs text-stone-500 mt-1">Unggah gambar logo Anda (maks. 1MB).</p>
                                </div>
                                <button type="submit" class="bg-indigo-600 text-white font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">Simpan Perubahan</button>
                            </form>
                        </div>

                        <!-- Team Management -->
                        <div id="settings-content-team" class="settings-content-pane hidden">
                            <h3 class="text-xl font-semibold mb-4 text-stone-900">Manajemen Tim</h3>
                            <p class="text-sm text-stone-600 mb-4">Kelola anggota tim yang memiliki akses ke aplikasi ini.</p>
                            <button id="invite-member-btn" class="bg-indigo-600 text-white font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors mb-4">Undang Anggota Baru</button>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white rounded-lg shadow-sm text-sm">
                                    <thead>
                                        <tr class="border-b border-stone-200">
                                            <th class="py-2 px-4 text-left text-stone-500 font-medium">Nama</th>
                                            <th class="py-2 px-4 text-left text-stone-500 font-medium">Email</th>
                                            <th class="py-2 px-4 text-left text-stone-500 font-medium">Peran</th>
                                            <th class="py-2 px-4 text-left text-stone-500 font-medium">Status</th>
                                            <th class="py-2 px-4 text-left text-stone-500 font-medium">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team-members-table-body">
                                        <!-- Team members will be populated here by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Display Settings -->
                        <div id="settings-content-display" class="settings-content-pane hidden">
                            <h3 class="text-xl font-semibold mb-4 text-stone-900">Pengaturan Tampilan</h3>
                            <div class="flex items-center justify-between p-4 bg-stone-100 rounded-lg">
                                <span>Mode Gelap</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" id="dark-mode-toggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-stone-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-stone-300 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                </label>
                            </div>
                            <p class="text-sm text-stone-600 mt-2">Aktifkan mode gelap untuk tampilan yang lebih nyaman di mata.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Add/Edit Content -->
    <div id="content-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <form id="content-form" class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <h2 id="modal-title" class="text-2xl font-bold text-stone-900">Tambah Konten Baru</h2>
                    <button type="button" id="close-modal-btn" class="p-1 rounded-full hover:bg-stone-200">
                        <svg class="w-6 h-6 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <input type="hidden" id="content-id">
                
                <div>
                    <label for="content-title" class="text-sm font-medium text-stone-700 block mb-1">Judul Konten</label>
                    <input type="text" id="content-title" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="Contoh: Tutorial Makeup Lebaran" required>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label for="content-date" class="text-sm font-medium text-stone-700 block mb-1">Tanggal</label>
                        <input type="date" id="content-date" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <!-- Deskripsi field added here -->
                    <div>
                        <label for="content-description" class="text-sm font-medium text-stone-700 block mb-1">Deskripsi Konten</label>
                        <textarea id="content-description" rows="3" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="Tulis deskripsi lengkap konten di sini."></textarea>
                    </div>
                </div>
                
                <!-- Platform Checkboxes -->
                <div>
                    <label class="text-sm font-medium text-stone-700 block mb-1">Platform</label>
                    <div id="content-platform-checkboxes" class="grid grid-cols-2 gap-2">
                        <!-- Checkboxes will be populated by JS -->
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label for="content-type" class="text-sm font-medium text-stone-700 block mb-1">Tipe Konten</label>
                        <input type="text" id="content-type" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="Contoh: Video, Carousel">
                    </div>
                     <div>
                        <label for="content-hashtags" class="text-sm font-medium text-stone-700 block mb-1">Keywords / Hashtags</label>
                        <textarea id="content-hashtags" rows="2" class="w-full border border-stone-300 rounded-md px-3 py-2" placeholder="#tutorial #lebaran2025"></textarea>
                    </div>
                </div>
                 <div>
                    <label for="content-cta" class="text-sm font-medium text-stone-700 block mb-1">Call-to-Action (CTA)</label>
                    <input type="text" id="content-cta" class="w-full border border-stone-300 rounded-md px-3 py-2" placeholder="Cek link di bio!">
                </div>
                <div>
                    <label for="content-notes" class="text-sm font-medium text-stone-700 block mb-1">Catatan Tambahan</label>
                    <textarea id="content-notes" rows="3" class="w-full border border-stone-300 rounded-md px-3 py-2" placeholder="Referensi musik, ide visual..."></textarea>
                </div>

                <!-- File Upload Section -->
                <div class="space-y-2 border-t border-stone-200 pt-4">
                    <p class="text-sm font-semibold text-stone-700">Unggah File (Gambar/Video) / Link</p>
                    <input type="file" id="content-file-upload" multiple class="w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <input type="text" id="content-link-upload" class="w-full border border-stone-300 rounded-md px-3 py-2 mt-2 focus:ring-2 focus:ring-indigo-500" placeholder="Atau tempel URL link di sini (mis: Google Drive, Dropbox)">
                    <button type="button" id="upload-to-drive-btn" class="bg-indigo-500 text-white font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-600 transition-colors text-sm mt-2">Simulasikan Unggah/Simpan Link</button>
                    <div id="uploaded-files-list" class="text-xs text-stone-600 mt-2 space-y-1">
                        <!-- Uploaded file names/links will be listed here -->
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div id="performance-metrics-section" class="hidden space-y-4 border-t border-stone-200 pt-4">
                    <p class="text-sm font-semibold text-stone-700">Input Metrik Performa per Platform</p>
                    <div id="platform-metrics-inputs">
                        <!-- Dynamic metric inputs per platform will be generated here -->
                    </div>
                </div>
                
                <!-- Status Dropdown (Moved to bottom) -->
                <div>
                    <label for="content-status" class="text-sm font-medium text-stone-700 block mb-1">Status</label>
                    <select id="content-status" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" required></select>
                </div>

                <!-- Status History Display -->
                <div id="status-history-section" class="space-y-2 border-t border-stone-200 pt-4 hidden">
                    <p class="text-sm font-semibold text-stone-700">Riwayat Status</p>
                    <div id="status-history-list">
                        <!-- History items will be populated here -->
                    </div>
                </div>

                <div class="flex flex-wrap justify-between items-center pt-4 gap-2">
                     <button type="button" id="delete-content-btn" class="text-sm text-red-600 hover:text-red-800 font-medium hidden">Hapus Konten</button>
                    <div class="flex gap-2">
                        <button type="button" id="copy-content-btn" class="bg-stone-200 text-stone-700 font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-stone-300 transition-colors">Salin Konten</button>
                        <button type="button" id="print-content-btn" class="bg-stone-200 text-stone-700 font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-stone-300 transition-colors">Cetak</button>
                        <button type="button" id="export-pdf-content-btn" class="bg-stone-200 text-stone-700 font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-stone-300 transition-colors">Ekspor PDF</button>
                    </div>
                    <button type="submit" id="save-content-btn" class="bg-indigo-600 text-white font-medium px-6 py-2 rounded-lg shadow-sm hover:bg-indigo-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="custom-confirm-modal-content">
            <h3 id="confirm-modal-title" class="text-lg font-bold mb-4 text-stone-900">Konfirmasi</h3>
            <p id="confirm-modal-message" class="mb-6 text-stone-700"></p>
            <div class="flex justify-end gap-3">
                <button id="confirm-modal-cancel" class="bg-stone-200 text-stone-700 font-medium px-4 py-2 rounded-lg hover:bg-stone-300 transition-colors">Batal</button>
                <button id="confirm-modal-ok" class="bg-red-600 text-white font-medium px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">OK</button>
            </div>
        </div>
    </div>

    <!-- Invite Member Modal -->
    <div id="invite-member-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <form id="invite-member-form" class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-stone-900">Undang Anggota</h2>
                    <button type="button" id="close-invite-modal-btn" class="p-1 rounded-full hover:bg-stone-200">
                        <svg class="w-6 h-6 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div>
                    <label for="invite-name" class="text-sm font-medium text-stone-700 block mb-1">Nama Anggota</label>
                    <input type="text" id="invite-name" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label for="invite-email" class="text-sm font-medium text-stone-700 block mb-1">Email Anggota</label>
                    <input type="email" id="invite-email" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="email@example.com" required>
                </div>
                <div>
                    <label for="invite-role" class="text-sm font-medium text-stone-700 block mb-1">Peran</label>
                    <select id="invite-role" class="w-full border border-stone-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500" required>
                        <option value="Viewer">Viewer</option>
                        <option value="Editor">Editor</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <button type="submit" class="bg-indigo-600 text-white font-medium px-6 py-2 rounded-lg shadow-sm hover:bg-indigo-700">Kirim Undangan</button>
            </form>
        </div>
    </div>

    <footer class="mt-8 text-center text-xs text-stone-400">
        <p>Di buat dengan ♥ oleh <a href="https://www.instagram.com/detrastudios" target="_blank" class="text-indigo-500 hover:underline">Detra Studios</a>. All rights reserved 2025.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DATA & CONFIG ---
            const PLATFORMS = [
                { id: 'instagram', name: 'Instagram', icon: 'IG', color: '#E4405F' },
                { id: 'tiktok', name: 'TikTok', icon: 'TK', color: '#000000' },
                { id: 'youtube', name: 'YouTube', icon: 'YT', color: '#FF0000' },
                { id: 'facebook', name: 'Facebook', icon: 'FB', color: '#1877F2' },
                { id: 'threads', name: 'Threads', icon: 'TH', color: '#000000' },
                { id: 'twitter', name: 'X (Twitter)', icon: 'X', color: '#1DA1F2' },
                { id: 'telegram', name: 'Telegram', icon: 'TG', color: '#0088CC' },
                { id: 'blog', name: 'Blog', icon: 'BL', color: '#F2911B' }
            ];

            const STATUSES = {
                ide: { name: 'Ide', color: '#6ee7b7' }, /* Teal 300 */
                draf: { name: 'Draf', color: '#93c5fd' }, /* Sky 300 */
                dikerjakan: { name: 'Dikerjakan', color: '#fcd34d' }, /* Amber 300 */
                revisi: { name: 'Revisi', color: '#fbbf24' }, /* Amber 400 - New Status */
                review: { name: 'Review', color: '#fda4af' }, /* Rose 300 */
                terjadwal: { name: 'Terjadwal', color: '#a5b4fc' }, /* Indigo 300 */
                terpublikasi: { name: 'Terpublikasi', color: '#86efac' } /* Green 300 */
            };
            
            let contentData = [
                { id: 1, date: '2025-07-03', title: 'Review Film "Mencari Hilal"', description: 'Analisis mendalam tentang sinematografi dan pesan moral film terbaru.', platform: ['youtube'], status: 'terpublikasi', type: 'Video Review', hashtags: '#reviewfilm #filmindonesia', cta: 'Tonton selengkapnya di channel YouTube kami!', notes: 'Fokus pada sinematografi dan pesan moral.', files: [], links: [], statusHistory: [{ timestamp: '2025-07-01T10:00:00Z', status: 'draf', user: 'Admin Pengguna', userColor: '#FF5733' }, { timestamp: '2025-07-02T14:30:00Z', status: 'review', user: 'Siti Aminah', userColor: '#33FF57' }, { timestamp: '2025-07-03T09:00:00Z', status: 'terpublikasi', user: 'Admin Pengguna', userColor: '#FF5733' }], metrics: { youtube: { views: 25700, likes: 2100, comments: 153, saves: 0, shares: 0 } } },
                { id: 2, date: '2025-07-05', title: 'Challenge TikTok terbaru', description: 'Ikuti tantangan viral terbaru dan menangkan hadiah menarik!', platform: ['tiktok'], status: 'terpublikasi', type: 'Video Pendek', hashtags: '#challenge #viraltiktok', cta: 'Ikutan challenge ini!', notes: 'Cari musik yang lagi trending.', files: [], links: [], statusHistory: [{ timestamp: '2025-07-03T11:00:00Z', status: 'ide', user: 'Admin Pengguna', userColor: '#FF5733' }, { timestamp: '2025-07-04T16:00:00Z', status: 'dikerjakan', user: 'Siti Aminah', userColor: '#33FF57' }, { timestamp: '2025-07-05T08:00:00Z', status: 'terpublikasi', user: 'Admin Pengguna', userColor: '#FF5733' }], metrics: { tiktok: { views: 88000, likes: 12000, comments: 450, saves: 0, shares: 0 } } },
                { id: 3, date: '2025-07-08', title: 'Infografis HUT RI', description: 'Infografis menarik tentang sejarah dan fakta unik Hari Kemerdekaan Republik Indonesia.', platform: ['instagram'], status: 'terpublikasi', type: 'Carousel', hashtags: '#hutri #17agustus #indonesia', cta: 'Bagikan semangat kemerdekaanmu!', notes: 'Gunakan filter merah putih.', files: [], links: [], statusHistory: [{ timestamp: '2025-07-06T09:00:00Z', status: 'draf', user: 'Siti Aminah', userColor: '#33FF57' }, { timestamp: '2025-07-07T13:00:00Z', status: 'review', user: 'Admin Pengguna', userColor: '#FF5733' }, { timestamp: '2025-07-08T07:00:00Z', status: 'terpublikasi', user: 'Admin Pengguna', userColor: '#FF5733' }], metrics: { instagram: { views: 15200, likes: 1800, comments: 98, saves: 0, shares: 0 } } },
                { id: 4, date: '2025-07-15', title: 'Resep Opor Ayam Spesial', description: 'Resep opor ayam klasik dengan sentuhan modern, cocok untuk acara keluarga.', platform: ['blog'], status: 'terjadwal', type: 'Artikel', hashtags: '#resep #oporayam #masakanindonesia', cta: 'Coba resepnya dan tag kami!', notes: 'Perlu foto step-by-step yang bagus.', files: [], links: [], statusHistory: [{ timestamp: '2025-07-10T10:00:00Z', status: 'ide', user: 'Admin Pengguna', userColor: '#FF5733' }, { timestamp: '2025-07-12T14:00:00Z', status: 'draf', user: 'Siti Aminah', userColor: '#33FF57' }, { timestamp: '2025-07-13T16:00:00Z', status: 'terjadwal', user: 'Admin Pengguna', userColor: '#FF5733' }], metrics: {} },
                { id: 5, date: '2025-07-22', title: 'Q&A Live Session', description: 'Sesi tanya jawab langsung dengan audiens tentang tips dan trik content creation.', platform: ['instagram', 'facebook'], status: 'revisi', type: 'Live Stream', hashtags: '#qna #live', cta: 'Siapkan pertanyaanmu!', notes: 'Siapkan daftar pertanyaan umum.', files: [], links: [], statusHistory: [{ timestamp: '2025-07-18T09:00:00Z', status: 'draf', user: 'Admin Pengguna', userColor: '#FF5733' }, { timestamp: '2025-07-19T11:00:00Z', status: 'revisi', user: 'Siti Aminah', userColor: '#33FF57' }], metrics: {} },
                { id: 6, date: '2025-06-25', title: 'Tips Produktif WFH', description: 'Panduan lengkap untuk tetap produktif saat bekerja dari rumah, termasuk manajemen waktu.', platform: ['blog'], status: 'terpublikasi', type: 'Artikel', hashtags: '#wfh #produktivitas', cta: 'Baca tips lengkapnya!', notes: 'Sertakan infografis.', files: [], links: [], statusHistory: [{ timestamp: '2025-06-20T10:00:00Z', status: 'draf', user: 'Admin Pengguna', userColor: '#FF5733' }, { timestamp: '2025-06-24T14:00:00Z', status: 'terpublikasi', user: 'Admin Pengguna', userColor: '#FF5733' }], metrics: { blog: { views: 8500, likes: 750, comments: 45, saves: 0, shares: 0 } } },
                { id: 7, date: '2025-06-10', title: 'Vlog Liburan ke Bali', description: 'Jelajahi keindahan Bali dalam vlog perjalanan kami, dari pantai hingga pegunungan.', platform: ['youtube'], status: 'terpublikasi', type: 'Vlog', hashtags: '#bali #liburan', cta: 'Lihat keindahan Bali!', notes: 'Highlight tempat wisata populer.', files: [], links: [], statusHistory: [{ timestamp: '2025-06-05T09:00:00Z', status: 'draf', user: 'Siti Aminah', userColor: '#33FF57' }, { timestamp: '2025-06-09T12:00:00Z', status: 'terpublikasi', user: 'Admin Pengguna', userColor: '#FF5733' }], metrics: { youtube: { views: 50000, likes: 4500, comments: 300, saves: 0, shares: 0 } } }
            ];

            let teamMembers = [
                { id: 1, name: 'Admin Pengguna', email: 'admin@example.com', password: 'admin123', role: 'Admin', status: 'Aktif', color: '#FF5733' }, // Renamed default user
                { id: 2, name: 'Siti Aminah', email: 'siti@example.com', password: 'siti123', role: 'Editor', status: 'Aktif', color: '#33FF57' },
                { id: 3, name: 'Joko Susilo', email: 'joko@example.com', password: 'joko123', role: 'Viewer', status: 'Menunggu', color: '#3357FF' }
            ];

            let appSettings = {
                companyName: 'Detra Studios', // Updated company name for login page
                theme: 'light', // 'light' or 'dark'
                account: {
                    name: '', // Will be set on login
                    email: '', // Will be set on login
                    role: '', // Will be set on login
                    profilePicture: 'https://placehold.co/80x80/E0E7FF/4F46E5?text=PP' // Default profile picture
                },
                companyLogo: 'https://placehold.co/60x60/E0E7FF/4F46E5?text=Logo' // Default logo
            };

            const INITIAL_ADMIN_EMAIL = 'initial_admin@example.com'; // Special email for the primary admin signup

            let currentDate = new Date(); // Used for calendar
            let reportDate = new Date(); // Used for report filters
            let activeView = 'calendar';
            let activeCalendarSubView = 'grid'; // 'grid' or 'list'
            let activeSettingsPane = 'account';
            let chartInstances = {};

            // --- DOM ELEMENTS ---
            const loginPage = document.getElementById('login-page');
            const appPage = document.getElementById('app');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form'); // New signup form
            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const loginErrorMessage = document.getElementById('login-error-message');
            const logoutBtn = document.getElementById('logout-btn');

            const loginTabBtn = document.getElementById('login-tab-btn'); // New login tab button
            const signupTabBtn = document.getElementById('signup-tab-btn'); // New signup tab button
            const loginLinkFromSignup = document.getElementById('login-link-from-signup'); // Link from signup to login

            const loginCompanyLogoDisplay = document.getElementById('login-company-logo-display'); // Login page logo
            const loginCompanyNameDisplay = document.getElementById('login-company-name-display'); // Login page company name


            const navCalendar = document.getElementById('nav-calendar');
            const navReport = document.getElementById('nav-report');
            const navSettings = document.getElementById('nav-settings');
            const calendarView = document.getElementById('calendar-view');
            const reportView = document.getElementById('report-view');
            const settingsView = document.getElementById('settings-view');
            const calendarBody = document.getElementById('calendar-body');
            const monthYearCalEl = document.getElementById('month-year-cal');
            const modal = document.getElementById('content-modal');
            const contentForm = document.getElementById('content-form');
            const performanceMetricsSection = document.getElementById('performance-metrics-section');
            const platformMetricsInputs = document.getElementById('platform-metrics-inputs'); // New element for dynamic metric inputs
            const companyNameDisplay = document.getElementById('company-name-display');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const statusHistorySection = document.getElementById('status-history-section');
            const statusHistoryList = document.getElementById('status-history-list');
            const analyticalInsightsOutput = document.getElementById('analytical-insights-output');
            const uploadToFileBtn = document.getElementById('upload-to-drive-btn');
            const fileUploadInput = document.getElementById('content-file-upload');
            const contentLinkUpload = document.getElementById('content-link-upload'); // New link input
            const uploadedFilesList = document.getElementById('uploaded-files-list');
            const addNewContentBtn = document.getElementById('add-new-content-btn'); // Get the add new content button

            const calendarGridViewContainer = document.getElementById('calendar-grid-view-container');
            const calendarListViewContainer = document.getElementById('calendar-list-view-container');
            const calendarListBody = document.getElementById('calendar-list-body');
            const viewCalendarGridBtn = document.getElementById('view-calendar-grid');
            const viewCalendarListBtn = document.getElementById('view-calendar-list');


            const settingsNavButtons = {
                account: document.getElementById('settings-nav-account'),
                company: document.getElementById('settings-nav-company'),
                team: document.getElementById('settings-nav-team'),
                display: document.getElementById('settings-nav-display')
            };
            const settingsContentPanes = {
                account: document.getElementById('settings-content-account'),
                company: document.getElementById('settings-content-company'),
                team: document.getElementById('settings-content-team'),
                display: document.getElementById('settings-content-display')
            };

            const customConfirmModal = document.getElementById('custom-confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalMessage = document.getElementById('confirm-modal-message');
            const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel');
            const confirmModalOkBtn = document.getElementById('confirm-modal-ok');

            const inviteMemberModal = document.getElementById('invite-member-modal');
            const inviteMemberForm = document.getElementById('invite-member-form');
            const closeInviteModalBtn = document.getElementById('close-invite-modal-btn');

            const deleteContentBtn = document.getElementById('delete-content-btn');
            const copyContentBtn = document.getElementById('copy-content-btn');
            const printContentBtn = document.getElementById('print-content-btn');
            const exportPdfContentBtn = document.getElementById('export-pdf-content-btn');
            const saveContentBtn = document.getElementById('save-content-btn');

            // --- USER ROLES AND PERMISSIONS ---
            const ROLES = {
                Admin: {
                    canAdd: true,
                    canEdit: true,
                    canDelete: true,
                    canManageTeam: true,
                    canViewReports: true
                },
                Editor: {
                    canAdd: true,
                    canEdit: true,
                    canDelete: false,
                    canManageTeam: false,
                    canViewReports: true
                },
                Viewer: {
                    canAdd: false,
                    canEdit: false,
                    canDelete: false,
                    canManageTeam: false,
                    canViewReports: true
                }
            };

            // --- CORE FUNCTIONS ---
            
            function initializeApp() {
                loadSettings();
                // Ensure all existing team members have a color
                teamMembers.forEach(member => {
                    if (!member.color) {
                        member.color = generateRandomColor();
                    }
                });
                saveSettings(); // Save updated team members with colors
                applyTheme(appSettings.theme);
                setupEventListeners();
                populateSelects();
                populatePlatformCheckboxes(); // New function for checkboxes
                populateReportDateFilters();
                
                // Set login page company info
                loginCompanyLogoDisplay.src = appSettings.companyLogo;
                loginCompanyNameDisplay.textContent = appSettings.companyName;

                // Check if user is already logged in
                const loggedInUserEmail = localStorage.getItem('loggedInUserEmail');
                if (loggedInUserEmail) {
                    const user = teamMembers.find(member => member.email === loggedInUserEmail);
                    if (user) {
                        appSettings.account.name = user.name;
                        appSettings.account.email = user.email;
                        appSettings.account.role = user.role;
                        showApp();
                    } else {
                        showLoginPage();
                    }
                } else {
                    showLoginPage();
                }
                updateCompanyNameDisplay(); // Update main app header
                updateAccountSettingsForm();
                updateCompanySettingsForm();
            }

            function showLoginPage() {
                loginPage.classList.remove('hidden');
                appPage.classList.add('hidden');
                loginErrorMessage.classList.add('hidden'); // Hide error on page load
                showLoginForm(); // Default to login form
            }

            function showApp() {
                loginPage.classList.add('hidden');
                appPage.classList.remove('hidden');
                updateView(); // Render the initial app view (calendar)
                applyPermissions(); // Apply permissions after login
            }

            function showLoginForm() {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                loginTabBtn.classList.add('active');
                signupTabBtn.classList.remove('active');
                loginErrorMessage.classList.add('hidden'); // Hide error when switching forms
            }

            function showSignupForm() {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                loginTabBtn.classList.remove('active');
                signupTabBtn.classList.add('active');
                loginErrorMessage.classList.add('hidden'); // Hide error when switching forms
            }

            function applyPermissions() {
                const userRole = appSettings.account.role;
                const permissions = ROLES[userRole];

                // Calendar View Permissions
                addNewContentBtn.style.display = permissions.canAdd ? 'inline-flex' : 'none';

                // Content Modal Permissions
                contentForm.querySelectorAll('input, select, textarea').forEach(el => {
                    if (el.id !== 'content-id' && el.id !== 'content-date') { // Always allow date and ID to be seen/set
                        el.readOnly = !permissions.canEdit;
                        el.disabled = !permissions.canEdit;
                        if (el.type === 'checkbox') { // Handle checkboxes specifically
                            el.disabled = !permissions.canEdit;
                        }
                    }
                });
                uploadToFileBtn.style.display = permissions.canEdit ? 'inline-flex' : 'none';
                fileUploadInput.disabled = !permissions.canEdit;
                contentLinkUpload.readOnly = !permissions.canEdit;
                contentLinkUpload.disabled = !permissions.canEdit;

                deleteContentBtn.style.display = permissions.canDelete ? 'inline-flex' : 'none';
                saveContentBtn.style.display = permissions.canEdit ? 'inline-flex' : 'none';

                // Settings View Permissions
                // Company and Team Management only for Admin
                settingsNavButtons.company.style.display = permissions.canManageTeam ? 'block' : 'none';
                settingsNavButtons.team.style.display = permissions.canManageTeam ? 'block' : 'none';
                
                // Disable forms in settings if no permission
                // Account settings: always editable for self
                document.getElementById('account-name').readOnly = false;
                document.getElementById('account-name').disabled = false;
                document.getElementById('profile-picture-upload').disabled = false;
                document.getElementById('account-password').readOnly = false;
                document.getElementById('account-password').disabled = false;
                document.getElementById('account-settings-form').querySelector('button[type="submit"]').disabled = false;

                // Company settings: only editable by Admin
                document.getElementById('company-settings-form').querySelectorAll('input, select, button').forEach(el => {
                    el.disabled = !permissions.canManageTeam;
                });
                // Team management: only editable by Admin
                document.getElementById('invite-member-btn').style.display = permissions.canManageTeam ? 'inline-flex' : 'none';

                // Display settings: always editable for all roles
                document.getElementById('dark-mode-toggle').disabled = false;
            }


            function updateView() {
                calendarView.classList.add('hidden');
                reportView.classList.add('hidden');
                settingsView.classList.add('hidden');

                navCalendar.classList.remove('active');
                navReport.classList.remove('active');
                navSettings.classList.remove('active');

                if (activeView === 'calendar') {
                    calendarView.classList.remove('hidden');
                    navCalendar.classList.add('active');
                    updateCalendarView(); // Call a new function to handle sub-views
                } else if (activeView === 'report') {
                    reportView.classList.remove('hidden');
                    navReport.classList.add('active');
                    renderReport();
                } else if (activeView === 'settings') {
                    settingsView.classList.remove('hidden');
                    navSettings.classList.add('active');
                    renderSettings();
                }
            }

            function updateCalendarView() {
                if (activeCalendarSubView === 'grid') {
                    calendarGridViewContainer.classList.remove('hidden');
                    calendarListViewContainer.classList.add('hidden');
                    viewCalendarGridBtn.classList.add('active');
                    viewCalendarListBtn.classList.remove('active');
                    renderCalendarGrid();
                } else {
                    calendarGridViewContainer.classList.add('hidden');
                    calendarListViewContainer.classList.remove('hidden');
                    viewCalendarGridBtn.classList.remove('active');
                    viewCalendarListBtn.classList.add('active');
                    renderCalendarList();
                }
            }
            
            function formatNumber(num) {
                if (num === null || num === undefined) return 'N/A';
                return new Intl.NumberFormat('id-ID').format(num);
            }

            function showCustomConfirm(title, message) {
                return new Promise((resolve) => {
                    confirmModalTitle.textContent = title;
                    confirmModalMessage.textContent = message;
                    customConfirmModal.classList.remove('hidden');
                    customConfirmModal.classList.add('flex');

                    const onOk = () => {
                        customConfirmModal.classList.add('hidden');
                        customConfirmModal.classList.remove('flex');
                        confirmModalOkBtn.removeEventListener('click', onOk);
                        confirmModalCancelBtn.removeEventListener('click', onCancel);
                        resolve(true);
                    };

                    const onCancel = () => {
                        customConfirmModal.classList.add('hidden');
                        customConfirmModal.classList.remove('flex');
                        confirmModalOkBtn.removeEventListener('click', onOk);
                        confirmModalCancelBtn.removeEventListener('click', onCancel);
                        resolve(false);
                    };

                    confirmModalOkBtn.addEventListener('click', onOk);
                    confirmModalCancelBtn.addEventListener('click', onCancel);
                    customConfirmModal.addEventListener('click', (e) => {
                        if (e.target === customConfirmModal) onCancel();
                    });
                });
            }

            // --- THEME FUNCTIONS ---
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.checked = true;
                } else {
                    document.body.classList.remove('dark-mode');
                    darkModeToggle.checked = false;
                }
                appSettings.theme = theme;
                saveSettings();
            }

            function toggleTheme() {
                const newTheme = appSettings.theme === 'light' ? 'dark' : 'light';
                applyTheme(newTheme);
            }

            // --- SETTINGS STORAGE ---
            function saveSettings() {
                localStorage.setItem('cpiSettings', JSON.stringify(appSettings));
                localStorage.setItem('cpiTeamMembers', JSON.stringify(teamMembers));
                localStorage.setItem('cpiContentData', JSON.stringify(contentData));
            }

            function loadSettings() {
                const savedSettings = localStorage.getItem('cpiSettings');
                if (savedSettings) {
                    appSettings = JSON.parse(savedSettings);
                }
                const savedTeamMembers = localStorage.getItem('cpiTeamMembers');
                if (savedTeamMembers) {
                    teamMembers = JSON.parse(savedTeamMembers);
                }
                const savedContentData = localStorage.getItem('cpiContentData');
                if (savedContentData) {
                    contentData = JSON.parse(savedContentData);
                    // Ensure platform is an array for older data and metrics structure
                    contentData.forEach(item => {
                        if (typeof item.platform === 'string') {
                            item.platform = [item.platform];
                        }
                        if (!item.metrics) {
                            item.metrics = {};
                            // Migrate old views, likes, comments if they exist and are not in metrics
                            if (item.views || item.likes || item.comments) {
                                if (item.platform.length > 0) {
                                    item.metrics[item.platform[0]] = {
                                        views: item.views || 0,
                                        likes: item.likes || 0,
                                        comments: item.comments || 0,
                                        saves: 0, // Default new metrics
                                        shares: 0  // Default new metrics
                                    };
                                }
                            }
                            delete item.views; // Remove old top-level properties
                            delete item.likes;
                            delete item.comments;
                        } else {
                            // Ensure all metrics have saves and shares
                            for (const p in item.metrics) {
                                if (item.metrics[p].saves === undefined) item.metrics[p].saves = 0;
                                if (item.metrics[p].shares === undefined) item.metrics[p].shares = 0;
                            }
                        }
                        if (!item.links) { // Ensure links array exists
                            item.links = [];
                        }
                    });
                }
            }

            // --- CALENDAR FUNCTIONS ---
            function renderCalendarGrid() {
                calendarBody.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                monthYearCalEl.textContent = `${new Date(year, month).toLocaleString('id-ID', { month: 'long', year: 'numeric' })}`;
                
                // Get the first day of the month (0 for Sunday, 1 for Monday...)
                // We want Monday to be the first day of the week in the grid, so adjust if Sunday is 0
                let firstDayOfMonth = new Date(year, month, 1).getDay();
                firstDayOfMonth = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; // Adjust Sunday (0) to be last (6), Monday (1) to be first (0)

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const platformFilter = document.getElementById('filter-platform').value;
                const statusFilter = document.getElementById('filter-status').value;

                const filteredContent = contentData.filter(item => {
                    // Correctly parse date to avoid timezone issues
                    const itemDateParts = item.date.split('-').map(Number);
                    const itemDate = new Date(itemDateParts[0], itemDateParts[1] - 1, itemDateParts[2]); 

                    const inMonth = itemDate.getFullYear() === year && itemDate.getMonth() === month;
                    const platformMatch = platformFilter === 'all' || item.platform.includes(platformFilter); // Check if array includes
                    const statusMatch = statusFilter === 'all' || item.status === statusFilter;
                    return inMonth && platformMatch && statusMatch;
                });
                
                // Fill leading empty cells (adjust for Monday start)
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarBody.insertAdjacentHTML('beforeend', `<div class="border-t border-r border-stone-200 bg-stone-50"></div>`);
                }
                
                // Fill day cells
                for (let day = 1; day <= daysInMonth; day++) {
                    // Create a date object for the current day, explicitly avoiding timezone issues
                    const dayDate = new Date(year, month, day);
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; //YYYY-MM-DD format

                    let cellClasses = 'day-cell p-1.5 border-t border-r border-stone-200 flex flex-col gap-1 overflow-y-auto relative cursor-pointer hover:bg-stone-100 transition-colors';
                    const isToday = dayDate.toDateString() === new Date().toDateString();
                    if (isToday) cellClasses += ' bg-indigo-50';

                    let dayNumberClass = "text-xs font-semibold";
                    if (isToday) dayNumberClass += " text-white bg-indigo-600 rounded-full w-5 h-5 flex items-center justify-center";

                    const contentForDay = filteredContent.filter(item => item.date === dateStr).map(item => {
                        const status = STATUSES[item.status];
                        const latestStatusEntry = item.statusHistory ? item.statusHistory[item.statusHistory.length - 1] : null;
                        const picName = latestStatusEntry ? latestStatusEntry.user : 'N/A';
                        const picColor = latestStatusEntry ? latestStatusEntry.userColor : '#6b7280';

                        // Only show PIC for non-published content
                        const picDisplay = item.status !== 'terpublikasi' ? `<span class="text-stone-500 text-xs flex items-center"><span class="member-color-dot" style="background-color: ${picColor};"></span>${picName}</span>` : '';

                        // Use the first platform's icon and color for display in calendar cell
                        const displayPlatform = item.platform.length > 0 ? PLATFORMS.find(p => p.id === item.platform[0]) : null;

                        return `<div data-id="${item.id}" class="content-item text-xs p-1.5 rounded-md border-l-4" style="border-color: ${status.color}; background-color: ${status.color}20;">
                            <div class="flex items-center gap-1.5">
                                <div class="platform-icon flex-shrink-0" style="background-color: ${displayPlatform?.color || '#9ca3af'}">${displayPlatform?.icon || '?'}</div>
                                <p class="font-medium truncate flex-grow">${item.title}</p>
                            </div>
                            ${picDisplay}
                        </div>`;
                    }).join('');
                    
                    const cellHTML = `<div class="${cellClasses}" data-date="${dateStr}"><span class="${dayNumberClass}">${day}</span><div class="space-y-1">${contentForDay}</div></div>`;
                    calendarBody.insertAdjacentHTML('beforeend', cellHTML);
                }
                 document.querySelectorAll('.day-cell').forEach(cell => cell.addEventListener('click', e => { if (!e.target.closest('.content-item')) openModal(cell.dataset.date); }));
                 document.querySelectorAll('.content-item').forEach(item => item.addEventListener('click', e => { e.stopPropagation(); openModal(null, item.dataset.id); }));
            }

            function renderCalendarList() {
                calendarListBody.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const filteredContent = contentData.filter(item => {
                    const itemDateParts = item.date.split('-').map(Number);
                    const itemDate = new Date(itemDateParts[0], itemDateParts[1] - 1, itemDateParts[2]); 
                    return itemDate.getFullYear() === year && itemDate.getMonth() === month;
                }).sort((a, b) => {
                    // Sort by date then by status (unpublished first)
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (dateA.getTime() !== dateB.getTime()) {
                        return dateA - dateB;
                    }
                    const statusOrder = ['ide', 'draf', 'dikerjakan', 'revisi', 'review', 'terjadwal', 'terpublikasi'];
                    return statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status);
                });

                if (filteredContent.length === 0) {
                    calendarListBody.innerHTML = '<p class="text-stone-500 text-center py-4">Tidak ada konten untuk bulan ini.</p>';
                    return;
                }

                let lastDate = '';
                filteredContent.forEach(item => {
                    const itemDateParts = item.date.split('-');
                    const itemDate = new Date(itemDateParts[0], itemDateParts[1] - 1, itemDateParts[2]);
                    const dateDisplay = itemDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });

                    if (dateDisplay !== lastDate) {
                        calendarListBody.insertAdjacentHTML('beforeend', `<h4 class="text-lg font-bold text-stone-800 mt-4 mb-2">${dateDisplay}</h4>`);
                        lastDate = dateDisplay;
                    }

                    const statusInfo = STATUSES[item.status];
                    const latestStatusEntry = item.statusHistory ? item.statusHistory[item.statusHistory.length - 1] : null;
                    const picName = latestStatusEntry ? latestStatusEntry.user : 'N/A';
                    const picColor = latestStatusEntry ? latestStatusEntry.userColor : '#6b7280';

                    const picDisplay = item.status !== 'terpublikasi' ? `<span class="ios-list-pic flex items-center"><span class="member-color-dot" style="background-color: ${picColor};"></span>${picName}</span>` : '';
                    const platformNames = item.platform.map(pId => PLATFORMS.find(p => p.id === pId)?.name || pId).join(', ');

                    const listItemHtml = `
                        <div class="ios-list-item" data-id="${item.id}">
                            <div class="ios-list-date">${itemDate.getDate()}</div>
                            <div class="flex-grow">
                                <p class="ios-list-title">${item.title}</p>
                                <p class="text-xs text-stone-500">${platformNames}</p>
                            </div>
                            <span class="ios-list-status" style="background-color: ${statusInfo.color}20; color: ${statusInfo.color};">${statusInfo.name}</span>
                            ${picDisplay}
                        </div>
                    `;
                    calendarListBody.insertAdjacentHTML('beforeend', listItemHtml);
                });

                document.querySelectorAll('.ios-list-item').forEach(item => item.addEventListener('click', e => {
                    openModal(null, item.dataset.id);
                }));
            }
            
            function renderInspiration() {
                const inspoContainer = document.getElementById('local-inspiration-content');
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                // Inspirations for July (6) and August (7)
                const inspirations = { 
                    6: [{ day: 1, text: 'Hari Bhayangkara' }, { day: 23, text: 'Hari Anak Nasional' }], 
                    7: [{ day: 17, text: 'Hari Kemerdekaan RI! 🇮🇩' }, { day: 21, text: 'Hari Maritim Nasional' }] 
                };
                inspoContainer.innerHTML = '';
                const monthInspirations = inspirations[month] || [];
                if (monthInspirations.length > 0) {
                     monthInspirations.forEach(item => inspoContainer.innerHTML += `<div class="text-sm bg-stone-100 p-2 rounded-md"><p class="font-semibold">${item.text}</p><p class="text-xs text-stone-500">${item.day} ${new Date(year, month).toLocaleString('id-ID', { month: 'long' })}</p></div>`);
                } else {
                    inspoContainer.innerHTML = `<p class="text-sm text-stone-500">Tidak ada acara khusus tercatat bulan ini.</p>`;
                }
            }

            // --- REPORT FUNCTIONS ---
            function renderReport() {
                const year = parseInt(document.getElementById('report-year').value);
                const month = parseInt(document.getElementById('report-month').value);
                const selectedPlatformFilter = document.getElementById('report-platform-filter').value;
                
                const reportData = contentData.filter(item => {
                    // Correctly parse date to avoid timezone issues
                    const itemDateParts = item.date.split('-').map(Number);
                    const itemDate = new Date(itemDateParts[0], itemDateParts[1] - 1, itemDateParts[2]); 
                    
                    const inMonth = itemDate.getFullYear() === year && itemDate.getMonth() === month;
                    const isPublished = item.status === 'terpublikasi';
                    
                    // Filter by selected platform if not 'all'
                    const platformMatch = selectedPlatformFilter === 'all' || item.platform.includes(selectedPlatformFilter);

                    return inMonth && isPublished && platformMatch;
                });
                
                // 1. Render Summary Stats
                const summaryStatsContainer = document.getElementById('summary-stats');
                let totalViews = 0;
                let totalLikes = 0;
                let totalComments = 0;
                let totalSaves = 0;
                let totalShares = 0;

                reportData.forEach(item => {
                    for (const platformId in item.metrics) {
                        // Only sum metrics for the selected platform, or all if 'all' is chosen
                        if (selectedPlatformFilter === 'all' || platformId === selectedPlatformFilter) {
                            totalViews += item.metrics[platformId].views || 0;
                            totalLikes += item.metrics[platformId].likes || 0;
                            totalComments += item.metrics[platformId].comments || 0;
                            totalSaves += item.metrics[platformId].saves || 0;
                            totalShares += item.metrics[platformId].shares || 0;
                        }
                    }
                });

                const totalEngagement = totalLikes + totalComments + totalSaves + totalShares;
                const avgEngagementRate = totalViews > 0 ? ((totalEngagement / totalViews) * 100).toFixed(2) : 0;
                
                summaryStatsContainer.innerHTML = `
                    <div class="bg-stone-100 p-4 rounded-lg"><p class="text-sm text-stone-500">Total Views</p><p class="text-2xl font-bold">${formatNumber(totalViews)}</p></div>
                    <div class="bg-stone-100 p-4 rounded-lg"><p class="text-sm text-stone-500">Total Likes</p><p class="text-2xl font-bold">${formatNumber(totalLikes)}</p></div>
                    <div class="bg-stone-100 p-4 rounded-lg"><p class="text-sm text-stone-500">Total Komentar</p><p class="text-2xl font-bold">${formatNumber(totalComments)}</p></div>
                    <div class="bg-stone-100 p-4 rounded-lg"><p class="text-sm text-stone-500">Total Simpan</p><p class="text-2xl font-bold">${formatNumber(totalSaves)}</p></div>
                    <div class="bg-stone-100 p-4 rounded-lg"><p class="text-sm text-stone-500">Total Bagikan</p><p class="text-2xl font-bold">${formatNumber(totalShares)}</p></div>
                    <div class="bg-stone-100 p-4 rounded-lg col-span-2"><p class="text-sm text-stone-500">Avg. Engagement Rate</p><p class="text-2xl font-bold">${avgEngagementRate}%</p></div>
                `;

                // 2. Render Platform Performance Chart
                const platformData = {};
                reportData.forEach(item => {
                    for (const platformId in item.metrics) {
                        if (selectedPlatformFilter === 'all' || platformId === selectedPlatformFilter) {
                            if (!platformData[platformId]) {
                                platformData[platformId] = { engagement: 0 };
                            }
                            platformData[platformId].engagement += (item.metrics[platformId].likes || 0) + 
                                                                  (item.metrics[platformId].comments || 0) +
                                                                  (item.metrics[platformId].saves || 0) +
                                                                  (item.metrics[platformId].shares || 0);
                        }
                    }
                });

                const platformLabels = Object.keys(platformData).map(id => PLATFORMS.find(p => p.id === id)?.name);
                const platformEngagement = Object.values(platformData).map(d => d.engagement);
                // Modern, softer colors for bar chart
                const platformColors = ['#60a5fa', '#34d399', '#fca5a5', '#a78bfa', '#facc15', '#fb923c', '#ef4444', '#22c55e']; // Blue, Green, Red, Purple, Yellow, Orange shades

                renderBarChart('platform-performance-chart', platformLabels, platformEngagement, 'Total Engagement', platformColors);
                
                // 3. Render Content Performance Chart
                reportData.sort((a,b) => {
                    // Ensure sorting by correctly parsed local dates
                    const [aYear, aMonth, aDay] = a.date.split('-').map(Number);
                    const [bYear, bMonth, bDay] = b.date.split('-').map(Number);
                    const dateA = new Date(aYear, aMonth - 1, aDay);
                    const dateB = new Date(bYear, bMonth - 1, bDay);
                    return dateA - dateB;
                });
                const contentLabels = reportData.map(item => `${new Date(item.date).getDate()}: ${item.title.substring(0,16)}${item.title.length > 16 ? '...' : ''}`);
                const contentLikes = reportData.map(item => {
                    let totalItemLikes = 0;
                    for (const p in item.metrics) {
                        if (selectedPlatformFilter === 'all' || p === selectedPlatformFilter) {
                            totalItemLikes += item.metrics[p].likes || 0;
                        }
                    }
                    return totalItemLikes;
                });
                const contentComments = reportData.map(item => {
                    let totalItemComments = 0;
                    for (const p in item.metrics) {
                        if (selectedPlatformFilter === 'all' || p === selectedPlatformFilter) {
                            totalItemComments += item.metrics[p].comments || 0;
                        }
                    }
                    return totalItemComments;
                });
                // Modern, softer colors for line chart
                const lineColors = ['#818cf8', '#38bdf8']; // Indigo 400, Sky 400
                renderLineChart('content-performance-chart', contentLabels, contentLikes, contentComments, lineColors);

                // 4. Generate Analytical Insights
                generateAnalyticalInsights(reportData, totalViews, totalLikes, totalComments, totalSaves, totalShares, avgEngagementRate, platformData, selectedPlatformFilter);
            }

            function renderBarChart(canvasId, labels, data, label, colors) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (chartInstances[canvasId]) {
                    chartInstances[canvasId].destroy();
                }
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            backgroundColor: colors,
                            borderColor: colors.map(c => `${c}B3`),
                            borderWidth: 1,
                            borderRadius: 5 // Rounded bars for modern look
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                grid: { color: 'rgba(200, 200, 200, 0.2)' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }, 
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatNumber(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        } 
                    }
                });
            }

            function renderLineChart(canvasId, labels, data1, data2, colors) {
                 const ctx = document.getElementById(canvasId).getContext('2d');
                if (chartInstances[canvasId]) {
                    chartInstances[canvasId].destroy();
                }
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Likes', data: data1, borderColor: colors[0], backgroundColor: `${colors[0]}33`, fill: true, tension: 0.4, pointRadius: 4, pointHoverRadius: 6 },
                            { label: 'Komentar', data: data2, borderColor: colors[1], backgroundColor: `${colors[1]}33`, fill: true, tension: 0.4, pointRadius: 4, pointHoverRadius: 6 }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                grid: { color: 'rgba(200, 200, 200, 0.2)' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }, 
                            plugins: { 
                            legend: { position: 'top', labels: { usePointStyle: true } },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatNumber(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        } 
                    }
                });
            }

            function generateAnalyticalInsights(reportData, totalViews, totalLikes, totalComments, totalSaves, totalShares, avgEngagementRate, platformData, selectedPlatformFilter) {
                let analysis = [];
                const monthName = new Date(reportDate.getFullYear(), reportDate.getMonth()).toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                const filterPlatformName = selectedPlatformFilter === 'all' ? 'Semua Platform' : PLATFORMS.find(p => p.id === selectedPlatformFilter)?.name || selectedPlatformFilter;

                analysis.push(`<strong>Analisis Performa Konten Bulan ${monthName} (${filterPlatformName}):</strong>`);
                analysis.push(`Sebagai seorang ahli profesional analisis media sosial dan pemasar digital strategis, berikut adalah analisis komprehensif mengenai capaian konten Anda pada bulan ${monthName}, ${selectedPlatformFilter === 'all' ? 'untuk semua platform' : `khusus untuk platform ${filterPlatformName}`}, beserta saran dan masukan berdasarkan data yang diperoleh untuk kemajuan konten di bulan berikutnya.`);
                
                analysis.push(`\n**Ringkasan Metrik Utama:**`);
                analysis.push(`- Total Tampilan: **${formatNumber(totalViews)}**`);
                analysis.push(`- Total Suka: **${formatNumber(totalLikes)}**`);
                analysis.push(`- Total Komentar: **${formatNumber(totalComments)}**`);
                analysis.push(`- Total Simpan: **${formatNumber(totalSaves)}**`);
                analysis.push(`- Total Bagikan: **${formatNumber(totalShares)}**`);
                analysis.push(`- Rata-rata Tingkat Engagement: **${avgEngagementRate}%**`);
                
                if (totalViews === 0 && totalLikes === 0 && totalComments === 0 && totalSaves === 0 && totalShares === 0) {
                    analysis.push(`\n**Kesimpulan:** Tidak ada data performa yang tercatat untuk bulan ini ${selectedPlatformFilter === 'all' ? '' : `untuk platform ${filterPlatformName}`}. Ini bisa berarti tidak ada konten yang dipublikasikan atau metrik tidak dilacak. Untuk analisis yang efektif, pastikan semua konten yang dipublikasikan memiliki metrik yang terekam.`);
                } else {
                    analysis.push(`\n**Analisis Kinerja Keseluruhan:**`);
                    if (avgEngagementRate > 5) {
                        analysis.push(`- Tingkat engagement Anda (${avgEngagementRate}%) menunjukkan performa yang **sangat baik**. Audiens Anda tidak hanya melihat konten, tetapi juga aktif berinteraksi. Pertahankan strategi ini!`);
                    } else if (avgEngagementRate >= 2 && avgEngagementRate <= 5) {
                        analysis.push(`- Tingkat engagement Anda (${avgEngagementRate}%) berada pada level **cukup baik**. Ada potensi untuk meningkatkan interaksi lebih lanjut.`);
                    } else {
                        analysis.push(`- Tingkat engagement Anda (${avgEngagementRate}%) **perlu perhatian**. Ini mengindikasikan bahwa meskipun konten Anda mungkin dilihat, interaksi audiens masih rendah.`);
                    }

                    if (selectedPlatformFilter === 'all') {
                        const sortedPlatforms = Object.entries(platformData).sort(([, a], [, b]) => b.engagement - a.engagement);
                        if (sortedPlatforms.length > 0) {
                            const topPlatform = PLATFORMS.find(p => p.id === sortedPlatforms[0][0])?.name;
                            analysis.push(`\n**Performa per Platform:**`);
                            analysis.push(`- Platform dengan performa engagement terbaik adalah **${topPlatform}** dengan total engagement **${formatNumber(sortedPlatforms[0][1].engagement)}**. Ini adalah saluran utama Anda untuk interaksi. Fokuskan upaya kreatif dan anggaran iklan di sini.`);
                            if (sortedPlatforms.length > 1) {
                                const lowestPlatform = PLATFORMS.find(p => p.id === sortedPlatforms[sortedPlatforms.length - 1][0])?.name;
                                analysis.push(`- Performa di **${lowestPlatform}** relatif rendah. Evaluasi apakah konten yang diposting di sana sudah dioptimalkan untuk platform tersebut, atau apakah audiens di sana kurang responsif terhadap jenis konten Anda.`);
                            }
                        }
                    } else {
                        // If a specific platform is selected, provide insights for that platform
                        const currentPlatformData = platformData[selectedPlatformFilter];
                        if (currentPlatformData) {
                            analysis.push(`\n**Performa di ${filterPlatformName}:**`);
                            analysis.push(`- Total engagement di ${filterPlatformName} adalah **${formatNumber(currentPlatformData.engagement)}**. Analisis lebih lanjut jenis konten apa yang paling berhasil di platform ini.`);
                        } else {
                            analysis.push(`\n**Performa di ${filterPlatformName}:** Tidak ada data engagement yang tercatat untuk platform ini bulan ini.`);
                        }
                    }

                    const topContent = reportData.sort((a,b) => {
                        let totalEngagementA = 0;
                        for (const p in a.metrics) {
                            if (selectedPlatformFilter === 'all' || p === selectedPlatformFilter) {
                                totalEngagementA += (a.metrics[p].likes || 0) + (a.metrics[p].comments || 0) + (a.metrics[p].saves || 0) + (a.metrics[p].shares || 0);
                            }
                        }
                        let totalEngagementB = 0;
                        for (const p in b.metrics) {
                            if (selectedPlatformFilter === 'all' || p === selectedPlatformFilter) {
                                totalEngagementB += (b.metrics[p].likes || 0) + (b.metrics[p].comments || 0) + (b.metrics[p].saves || 0) + (b.metrics[p].shares || 0);
                            }
                        }
                        return totalEngagementB - totalEngagementA;
                    })[0];

                    if (topContent) {
                        analysis.push(`\n**Konten Berkinerja Terbaik:**`);
                        let topContentEngagement = 0;
                        for (const p in topContent.metrics) {
                             if (selectedPlatformFilter === 'all' || p === selectedPlatformFilter) {
                                topContentEngagement += (topContent.metrics[p].likes || 0) + (topContent.metrics[p].comments || 0) + (topContent.metrics[p].saves || 0) + (topContent.metrics[p].shares || 0);
                            }
                        }
                        analysis.push(`- Konten paling populer bulan ini adalah "**${topContent.title}**" di ${topContent.platform.map(pId => PLATFORMS.find(p => p.id === pId)?.name).join(', ') || 'beberapa platform'}, dengan total engagement **${formatNumber(topContentEngagement)}**. Analisis elemen kunci dari konten ini (misalnya, topik, format visual, narasi, CTA) dan identifikasi apa yang membuatnya resonan dengan audiens. Replikasi elemen-elemen sukses ini dalam strategi konten mendatang Anda.`);
                    }

                    analysis.push(`\n**Saran & Masukan untuk Bulan Berikutnya:**`);
                    if (avgEngagementRate < 5) {
                        analysis.push(`1.  **Fokus pada Interaksi:** Tingkatkan penggunaan Call-to-Action (CTA) yang kuat yang mendorong komentar, pertanyaan, atau berbagi. Pertimbangkan untuk mengadakan sesi Q&A langsung, polling interaktif, atau kuis di platform yang relevan.`);
                        analysis.push(`2.  **Eksperimen Format:** Jika engagement rendah, coba variasi format konten (misalnya, video pendek, infografis, carousel, cerita interaktif) untuk melihat apa yang paling menarik audiens Anda.`);
                    } else {
                        analysis.push(`1.  **Diversifikasi Konten Sukses:** Identifikasi lebih banyak topik atau format yang berkinerja tinggi dan buat variasi dari konten tersebut. Jangan takut untuk bereksperimen dengan sudut pandang baru.`);
                        analysis.push(`2.  **Optimasi Waktu Posting:** Dengan engagement yang sudah baik, analisis lebih lanjut data waktu posting terbaik untuk setiap platform untuk memaksimalkan jangkauan organik.`);
                    }
                    analysis.push(`3.  **Analisis Kompetitor:** Lakukan analisis terhadap kompetitor yang sukses di platform yang Anda ingin tingkatkan. Pelajari strategi mereka dan adaptasi ide-ide yang relevan.`);
                    analysis.push(`4.  **Manfaatkan Tren Lokal:** Terus pantau "Inspirasi Lokal" dan tren yang sedang berkembang di Indonesia. Konten yang relevan dengan budaya dan peristiwa lokal cenderung memiliki resonansi yang lebih tinggi.`);
                    analysis.push(`5.  **Kualitas Visual:** Pastikan kualitas visual dan audio konten Anda selalu prima. Visual yang menarik adalah kunci untuk menarik perhatian di platform media sosial yang ramai.`);
                    analysis.push(`6.  **Kolaborasi:** Pertimbangkan kolaborasi dengan *influencer* atau akun lain yang relevan untuk memperluas jangkauan audiens Anda.`);
                    analysis.push(`7.  **Ukur dan Adaptasi:** Terus pantau metrik performa secara rutin. Gunakan data ini untuk mengadaptasi strategi Anda secara dinamis. Apa yang berhasil bulan ini mungkin perlu disesuaikan bulan depan.`);
                }
                
                analyticalInsightsOutput.innerHTML = analysis.map(p => `<p>${p}</p>`).join('');
            }

            // --- MODAL & FORM FUNCTIONS ---
            function openModal(date, contentId = null) {
                const permissions = ROLES[appSettings.account.role];

                contentForm.reset();
                performanceMetricsSection.classList.add('hidden');
                platformMetricsInputs.innerHTML = ''; // Clear dynamic metric inputs
                statusHistorySection.classList.add('hidden'); // Hide history by default for new content
                uploadedFilesList.innerHTML = ''; // Clear previous file list
                document.getElementById('content-file-upload').value = ''; // Clear file input
                document.getElementById('content-link-upload').value = ''; // Clear link input
                
                // Clear all platform checkboxes
                document.querySelectorAll('#content-platform-checkboxes input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });

                const deleteBtn = document.getElementById('delete-content-btn');
                const copyBtn = document.getElementById('copy-content-btn');
                const printBtn = document.getElementById('print-content-btn');
                const exportPdfBtn = document.getElementById('export-pdf-content-btn');

                let currentContent = null;

                if (contentId) {
                    currentContent = contentData.find(item => item.id == contentId);
                    document.getElementById('modal-title').textContent = 'Edit Konten';
                    document.getElementById('content-id').value = currentContent.id;
                    document.getElementById('content-title').value = currentContent.title;
                    document.getElementById('content-date').value = currentContent.date;
                    document.getElementById('content-description').value = currentContent.description || ''; // Populate description field
                    document.getElementById('content-type').value = currentContent.type || '';
                    document.getElementById('content-hashtags').value = currentContent.hashtags || '';
                    document.getElementById('content-cta').value = currentContent.cta || '';
                    document.getElementById('content-notes').value = currentContent.notes || '';
                    
                    // Set platform checkboxes
                    currentContent.platform.forEach(pId => {
                        const checkbox = document.querySelector(`#content-platform-checkboxes input[value="${pId}"]`);
                        if (checkbox) checkbox.checked = true;
                    });

                    document.getElementById('content-status').value = currentContent.status; // Set status after content is loaded
                    
                    if(currentContent.status === 'terpublikasi') {
                        performanceMetricsSection.classList.remove('hidden');
                        renderPlatformMetricsInputs(currentContent.platform, currentContent.metrics);
                    }
                    deleteBtn.style.display = permissions.canDelete ? 'inline-flex' : 'none';
                    copyBtn.style.display = 'inline-flex'; // Copy is always allowed for anyone who can view
                    printBtn.style.display = 'inline-flex'; // Print is always allowed for anyone who can view
                    exportPdfBtn.style.display = 'inline-flex'; // Export is always allowed for anyone who can view
                    saveContentBtn.style.display = permissions.canEdit ? 'inline-flex' : 'none';


                    // Show and render status history
                    statusHistorySection.classList.remove('hidden');
                    renderStatusHistory(currentContent.statusHistory || []);

                    // Display existing uploaded files and links
                    if (currentContent.files && currentContent.files.length > 0) {
                        currentContent.files.forEach(file => {
                            uploadedFilesList.insertAdjacentHTML('beforeend', `<p class="text-xs text-stone-600">🔗 ${file.name}</p>`);
                        });
                    }
                    if (currentContent.links && currentContent.links.length > 0) {
                        currentContent.links.forEach(link => {
                            uploadedFilesList.insertAdjacentHTML('beforeend', `<p class="text-xs text-stone-600">🔗 <a href="${link}" target="_blank" class="text-indigo-600 hover:underline">${link}</a></p>`);
                        });
                    }

                } else { // New Content
                    document.getElementById('modal-title').textContent = 'Tambah Konten Baru';
                    document.getElementById('content-id').value = '';
                    document.getElementById('content-date').value = date;
                    document.getElementById('content-status').value = 'ide'; // Default status for new content
                    deleteBtn.style.display = 'none';
                    copyBtn.style.display = 'none';
                    printBtn.style.display = 'none';
                    exportPdfBtn.style.display = 'none';
                    saveContentBtn.style.display = permissions.canAdd ? 'inline-flex' : 'none'; // Only show save if can add
                    statusHistorySection.classList.add('hidden'); // Hide for new content
                }

                // Apply readOnly/disabled based on permissions
                contentForm.querySelectorAll('input, select, textarea').forEach(el => {
                    if (el.id !== 'content-id' && el.id !== 'content-date') { // Always allow date and ID to be seen/set
                        el.readOnly = !permissions.canEdit;
                        el.disabled = !permissions.canEdit;
                        if (el.type === 'checkbox') { // Handle checkboxes specifically
                            el.disabled = !permissions.canEdit;
                        }
                    }
                });
                uploadToFileBtn.style.display = permissions.canEdit ? 'inline-flex' : 'none';
                fileUploadInput.disabled = !permissions.canEdit;
                contentLinkUpload.readOnly = !permissions.canEdit;
                contentLinkUpload.disabled = !permissions.canEdit;

                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            function renderPlatformMetricsInputs(selectedPlatforms, existingMetrics = {}) {
                platformMetricsInputs.innerHTML = '';
                const permissions = ROLES[appSettings.account.role];

                if (selectedPlatforms.length === 0) {
                    platformMetricsInputs.innerHTML = '<p class="text-sm text-stone-500">Pilih setidaknya satu platform untuk memasukkan metrik.</p>';
                    return;
                }

                selectedPlatforms.forEach(platformId => {
                    const platformInfo = PLATFORMS.find(p => p.id === platformId);
                    const metrics = existingMetrics[platformId] || { views: '', likes: '', comments: '', saves: '', shares: '' };

                    const platformMetricsHtml = `
                        <div class="platform-metrics-group">
                            <h4 class="font-semibold text-stone-800 mb-3">${platformInfo.name} Metrik</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label for="metrics-${platformId}-views" class="text-sm font-medium text-stone-700 block mb-1">Views</label>
                                    <input type="number" id="metrics-${platformId}-views" data-platform="${platformId}" data-metric="views" class="w-full border border-stone-300 rounded-md px-3 py-2" placeholder="0" value="${metrics.views}" ${permissions.canEdit ? '' : 'readonly disabled'}>
                                </div>
                                <div>
                                    <label for="metrics-${platformId}-likes" class="text-sm font-medium text-stone-700 block mb-1">Likes</label>
                                    <input type="number" id="metrics-${platformId}-likes" data-platform="${platformId}" data-metric="likes" class="w-full border border-stone-300 rounded-md px-3 py-2" placeholder="0" value="${metrics.likes}" ${permissions.canEdit ? '' : 'readonly disabled'}>
                                </div>
                                <div>
                                    <label for="metrics-${platformId}-comments" class="text-sm font-medium text-stone-700 block mb-1">Komentar</label>
                                    <input type="number" id="metrics-${platformId}-comments" data-platform="${platformId}" data-metric="comments" class="w-full border border-stone-300 rounded-md px-3 py-2" placeholder="0" value="${metrics.comments}" ${permissions.canEdit ? '' : 'readonly disabled'}>
                                </div>
                                <div>
                                    <label for="metrics-${platformId}-saves" class="text-sm font-medium text-stone-700 block mb-1">Simpan</label>
                                    <input type="number" id="metrics-${platformId}-saves" data-platform="${platformId}" data-metric="saves" class="w-full border border-stone-300 rounded-md px-3 py-2" placeholder="0" value="${metrics.saves}" ${permissions.canEdit ? '' : 'readonly disabled'}>
                                </div>
                                <div>
                                    <label for="metrics-${platformId}-shares" class="text-sm font-medium text-stone-700 block mb-1">Bagikan</label>
                                    <input type="number" id="metrics-${platformId}-shares" data-platform="${platformId}" data-metric="shares" class="w-full border border-stone-300 rounded-md px-3 py-2" placeholder="0" value="${metrics.shares}" ${permissions.canEdit ? '' : 'readonly disabled'}>
                                </div>
                            </div>
                        </div>
                    `;
                    platformMetricsInputs.insertAdjacentHTML('beforeend', platformMetricsHtml);
                });
            }


            function closeModal() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            function handleFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('content-id').value;
                const oldContent = id ? contentData.find(item => item.id == id) : null;
                const oldStatus = oldContent ? oldContent.status : '';
                const newStatus = document.getElementById('content-status').value;
                const permissions = ROLES[appSettings.account.role];

                if (!permissions.canAdd && !permissions.canEdit) {
                    alert('Anda tidak memiliki izin untuk menambah atau mengedit konten.');
                    return;
                }

                // Get current user's name and color for status history
                const currentUser = appSettings.account.name;
                const currentUserTeamMember = teamMembers.find(member => member.name === currentUser);
                const currentUserColor = currentUserTeamMember ? currentUserTeamMember.color : '#6b7280'; // Default gray if not found

                // Collect selected platforms
                const selectedPlatforms = Array.from(document.querySelectorAll('#content-platform-checkboxes input[type="checkbox"]:checked'))
                                            .map(checkbox => checkbox.value);

                // Collect uploaded file names
                const uploadedFiles = [];
                const files = document.getElementById('content-file-upload').files;
                for (let i = 0; i < files.length; i++) {
                    uploadedFiles.push({ name: files[i].name, url: `simulated_url_${Date.now()}_${i}` }); // Simulated URL
                }

                // Collect uploaded links
                const uploadedLink = document.getElementById('content-link-upload').value.trim();
                const existingLinks = oldContent ? oldContent.links : [];
                const newLinks = uploadedLink ? [...existingLinks, uploadedLink] : existingLinks;

                // Collect metrics per platform
                const metrics = {};
                if (newStatus === 'terpublikasi') {
                    selectedPlatforms.forEach(pId => {
                        metrics[pId] = {
                            views: parseInt(document.getElementById(`metrics-${pId}-views`).value) || 0,
                            likes: parseInt(document.getElementById(`metrics-${pId}-likes`).value) || 0,
                            comments: parseInt(document.getElementById(`metrics-${pId}-comments`).value) || 0,
                            saves: parseInt(document.getElementById(`metrics-${pId}-saves`).value) || 0,
                            shares: parseInt(document.getElementById(`metrics-${pId}-shares`).value) || 0
                        };
                    });
                }


                const newContent = {
                    date: document.getElementById('content-date').value,
                    title: document.getElementById('content-title').value,
                    description: document.getElementById('content-description').value,
                    platform: selectedPlatforms, // Save as array
                    status: newStatus,
                    type: document.getElementById('content-type').value,
                    hashtags: document.getElementById('content-hashtags').value,
                    cta: document.getElementById('content-cta').value,
                    notes: document.getElementById('content-notes').value,
                    files: oldContent ? [...oldContent.files, ...uploadedFiles] : uploadedFiles, // Merge old and new files
                    links: newLinks, // Save links
                    statusHistory: oldContent ? [...oldContent.statusHistory] : [], // Initialize or copy existing history
                    metrics: metrics // Save collected metrics
                };

                // Add to status history if status changed or new content
                if (newStatus !== oldStatus || !id) {
                    newContent.statusHistory.push({
                        timestamp: new Date().toISOString(),
                        status: newStatus,
                        user: currentUser, // Use current user from settings
                        userColor: currentUserColor // Store user's color
                    });
                }
                
                if(id) {
                    newContent.id = parseInt(id);
                    contentData = contentData.map(item => item.id == id ? newContent : item);
                } else {
                    newContent.id = Date.now();
                    contentData.push(newContent);
                }
                saveSettings(); // Save content data
                updateView();
                closeModal();
            }

            function renderStatusHistory(history) {
                statusHistoryList.innerHTML = '';
                if (history && history.length > 0) {
                    history.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // Sort by time
                    history.forEach(entry => {
                        const statusInfo = STATUSES[entry.status];
                        const date = new Date(entry.timestamp).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                        const itemHtml = `
                            <div class="status-history-item" style="background-color: ${statusInfo.color}20; border-left: 4px solid ${statusInfo.color};">
                                <span><span class="member-color-dot" style="background-color: ${entry.userColor || '#6b7280'};"></span>${statusInfo.name} oleh ${entry.user}</span>
                                <span>${date}</span>
                            </div>
                        `;
                        statusHistoryList.insertAdjacentHTML('beforeend', itemHtml);
                    });
                } else {
                    statusHistoryList.innerHTML = '<p class="text-xs text-stone-500">Tidak ada riwayat status.</p>';
                }
            }

            // --- PRINT, COPY, EXPORT FUNCTIONS ---
            function copyContent() {
                const title = document.getElementById('content-title').value;
                const description = document.getElementById('content-description').value; // Use new description field
                const cta = document.getElementById('content-cta').value;
                const hashtags = document.getElementById('content-hashtags').value;
                const notes = document.getElementById('content-notes').value;
                const platforms = Array.from(document.querySelectorAll('#content-platform-checkboxes input[type="checkbox"]:checked'))
                                            .map(checkbox => PLATFORMS.find(p => p.id === checkbox.value)?.name || checkbox.value).join(', ');

                const textToCopy = `Judul: ${title}\nPlatform: ${platforms}\n\nDeskripsi:\n${description}\n\nCall-to-Action: ${cta}\n\nKeywords/Hashtags: ${hashtags}\n\nCatatan Tambahan:\n${notes}`;
                
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Konten berhasil disalin ke clipboard!'); // Using alert for simplicity, could use a custom toast
            }

            function printContent() {
                const contentId = document.getElementById('content-id').value;
                const content = contentData.find(item => item.id == contentId);
                if (!content) return;

                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write('<html><head><title>Cetak Konten</title>');
                printWindow.document.write('<style>');
                printWindow.document.write('body { font-family: sans-serif; padding: 20px; color: #333; }');
                printWindow.document.write('h1 { font-size: 24px; margin-bottom: 10px; color: #1f2937; }');
                printWindow.document.write('h2 { font-size: 20px; margin-top: 20px; margin-bottom: 10px; color: #1f2937; }');
                printWindow.document.write('p { margin-bottom: 5px; line-height: 1.5; }');
                printWindow.document.write('strong { font-weight: bold; }');
                printWindow.document.write('.status-history-item { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid; }');
                printWindow.document.write('.member-color-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }');
                printWindow.document.write('</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write(`<h1>${content.title}</h1>`);
                printWindow.document.write(`<p><strong>Tanggal:</strong> ${content.date}</p>`);
                printWindow.document.write(`<p><strong>Platform:</strong> ${content.platform.map(pId => PLATFORMS.find(p => p.id === pId)?.name || pId).join(', ') || '-'}</p>`);
                printWindow.document.write(`<p><strong>Status:</strong> ${STATUSES[content.status]?.name || content.status}</p>`);
                printWindow.document.write(`<p><strong>Tipe Konten:</strong> ${content.type || '-'}</p>`);
                printWindow.document.write(`<p><strong>Deskripsi:</strong> ${content.description || '-'}</p>`); // Print new description
                printWindow.document.write(`<p><strong>Keywords/Hashtags:</strong> ${content.hashtags || '-'}</p>`);
                printWindow.document.write(`<p><strong>Call-to-Action:</strong> ${content.cta || '-'}</p>`);
                printWindow.document.write(`<p><strong>Catatan Tambahan:</strong> ${content.notes || '-'}</p>`);
                
                if (content.status === 'terpublikasi' && Object.keys(content.metrics).length > 0) {
                    printWindow.document.write('<h2>Metrik Performa per Platform:</h2>');
                    for (const pId in content.metrics) {
                        const platformName = PLATFORMS.find(p => p.id === pId)?.name || pId;
                        const metrics = content.metrics[pId];
                        printWindow.document.write(`<h3>${platformName}</h3>`);
                        printWindow.document.write(`<p><strong>Views:</strong> ${formatNumber(metrics.views)}</p>`);
                        printWindow.document.write(`<p><strong>Likes:</strong> ${formatNumber(metrics.likes)}</p>`);
                        printWindow.document.write(`<p><strong>Komentar:</strong> ${formatNumber(metrics.comments)}</p>`);
                        printWindow.document.write(`<p><strong>Simpan:</strong> ${formatNumber(metrics.saves)}</p>`);
                        printWindow.document.write(`<p><strong>Bagikan:</strong> ${formatNumber(metrics.shares)}</p>`);
                    }
                }

                if (content.files && content.files.length > 0) {
                    printWindow.document.write('<h2>File Terkait:</h2>');
                    content.files.forEach(file => {
                        printWindow.document.write(`<p>${file.name}</p>`);
                    });
                }
                if (content.links && content.links.length > 0) {
                    printWindow.document.write('<h2>Link Terkait:</h2>');
                    content.links.forEach(link => {
                        printWindow.document.write(`<p><a href="${link}" target="_blank">${link}</a></p>`);
                    });
                }

                if (content.statusHistory && content.statusHistory.length > 0) {
                    printWindow.document.write('<h2>Riwayat Status:</h2>');
                    content.statusHistory.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)).forEach(entry => {
                        const statusInfo = STATUSES[entry.status];
                        const date = new Date(entry.timestamp).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                        printWindow.document.write(`
                            <div class="status-history-item" style="background-color: ${statusInfo.color}20; border-color: ${statusInfo.color};">
                                <span><span class="member-color-dot" style="background-color: ${entry.userColor || '#6b7280'};"></span>${statusInfo.name} oleh ${entry.user}</span>
                                <span>${date}</span>
                            </div>
                        `);
                    });
                }
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.print();
            }

            function exportPdfContent() {
                printContent(); 
            }

            function printReport() {
                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write('<html><head><title>Laporan Insight Bulanan</title>');
                printWindow.document.write('<style>');
                printWindow.document.write('body { font-family: sans-serif; padding: 20px; color: #333; }');
                printWindow.document.write('h1 { font-size: 28px; margin-bottom: 20px; color: #1f2937; text-align: center; }');
                printWindow.document.write('h2 { font-size: 22px; margin-top: 25px; margin-bottom: 10px; color: #1f2937; }');
                printWindow.document.write('h3 { font-size: 18px; margin-top: 15px; margin-bottom: 8px; color: #1f2937; }');
                printWindow.document.write('p { margin-bottom: 5px; line-height: 1.5; }');
                printWindow.document.write('strong { font-weight: bold; }');
                printWindow.document.write('.summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }');
                printWindow.document.write('.stat-card { background-color: #f0f4f8; padding: 15px; border-radius: 8px; text-align: center; }');
                printWindow.document.write('.stat-card p:first-child { font-size: 0.9em; color: #666; }');
                printWindow.document.write('.stat-card p:last-child { font-size: 1.8em; font-weight: bold; color: #333; }');
                printWindow.document.write('img { max-width: 100%; height: auto; display: block; margin: 0 auto 20px auto; }'); /* Added img style */
                printWindow.document.write('.analysis-output { background-color: #f0f4f8; padding: 15px; border-radius: 8px; line-height: 1.6; }');
                printWindow.document.write('</style>');
                printWindow.document.write('</head><body>');
                
                const reportMonthYear = document.getElementById('report-month').selectedOptions[0].text + ' ' + document.getElementById('report-year').value;
                const filterPlatformName = document.getElementById('report-platform-filter').selectedOptions[0].text;
                printWindow.document.write(`<h1>Laporan Insight Bulanan ${reportMonthYear} (${filterPlatformName})</h1>`);

                // Summary Stats
                printWindow.document.write('<h2>Ringkasan Metrik Utama</h2>');
                printWindow.document.write('<div class="summary-stats">');
                const summaryStatsHtml = document.getElementById('summary-stats').innerHTML;
                printWindow.document.write(summaryStatsHtml.replace(/bg-stone-100/g, 'stat-card')); // Use print-specific class
                printWindow.document.write('</div>');

                // Charts (render as images)
                printWindow.document.write('<h2>Performa Engagement per Platform</h2>');
                const platformChartCanvas = document.getElementById('platform-performance-chart');
                if (platformChartCanvas) {
                    printWindow.document.write(`<img id="print-platform-chart" src="">`); // Placeholder for image
                }
                
                printWindow.document.write('<h2>Performa Konten Individual</h2>');
                const contentChartCanvas = document.getElementById('content-performance-chart');
                if (contentChartCanvas) {
                    printWindow.document.write(`<img id="print-content-chart" src="">`); // Placeholder for image
                }

                // Analytical Insights
                printWindow.document.write('<h2>Analisis & Rekomendasi</h2>');
                printWindow.document.write(`<div class="analysis-output">${analyticalInsightsOutput.innerHTML}</div>`);

                printWindow.document.write('</body></html>');
                printWindow.document.close();

                // Wait for images to load before printing
                setTimeout(() => {
                    if (platformChartCanvas) {
                        printWindow.document.getElementById('print-platform-chart').src = platformChartCanvas.toDataURL('image/png');
                    }
                    if (contentChartCanvas) {
                        printWindow.document.getElementById('print-content-chart').src = contentChartCanvas.toDataURL('image/png');
                    }
                    // Give a very short moment for images to be assigned src
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 100); // Small delay to ensure images are loaded
                }, 500); // Delay before setting image sources, allowing Chart.js to render
            }

            function exportPdfReport() {
                printReport(); // Uses window.print() which allows "Save as PDF"
            }

            // --- SETTINGS FUNCTIONS ---
            function renderSettings() {
                Object.keys(settingsContentPanes).forEach(pane => {
                    settingsContentPanes[pane].classList.add('hidden');
                    settingsNavButtons[pane].classList.remove('active');
                });
                settingsContentPanes[activeSettingsPane].classList.remove('hidden');
                settingsNavButtons[activeSettingsPane].classList.add('active');

                if (activeSettingsPane === 'team') {
                    renderTeamMembers();
                } else if (activeSettingsPane === 'account') {
                    updateAccountSettingsForm();
                } else if (activeSettingsPane === 'company') {
                    updateCompanySettingsForm();
                } else if (activeSettingsPane === 'display') {
                    darkModeToggle.checked = (appSettings.theme === 'dark');
                }
                applyPermissions(); // Re-apply permissions for settings view elements
            }

            function updateCompanyNameDisplay() {
                companyNameDisplay.textContent = appSettings.companyName;
                document.getElementById('company-logo-display').src = appSettings.companyLogo;
            }

            function updateAccountSettingsForm() {
                document.getElementById('account-name').value = appSettings.account.name;
                document.getElementById('account-email').value = appSettings.account.email;
                document.getElementById('profile-picture-preview').src = appSettings.account.profilePicture;
            }

            function updateCompanySettingsForm() {
                document.getElementById('company-name').value = appSettings.companyName;
                document.getElementById('company-logo-preview').src = appSettings.companyLogo;
            }

            function generateRandomPassword(length = 8) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()';
                let password = '';
                for (let i = 0; i < length; i++) {
                    password += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return password;
            }

            function generateRandomColor() {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }

            function renderTeamMembers() {
                const tableBody = document.getElementById('team-members-table-body');
                tableBody.innerHTML = '';
                const permissions = ROLES[appSettings.account.role];

                teamMembers.forEach(member => {
                    const row = `
                        <tr class="border-b border-stone-100 last:border-b-0">
                            <td class="py-2 px-4 flex items-center"><span class="member-color-dot" style="background-color: ${member.color || '#6b7280'};"></span>${member.name}</td>
                            <td class="py-2 px-4">${member.email}</td>
                            <td class="py-2 px-4">
                                <select data-member-id="${member.id}" class="member-role-select bg-white border border-stone-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-indigo-500" ${permissions.canManageTeam ? '' : 'disabled'}>
                                    <option value="Viewer" ${member.role === 'Viewer' ? 'selected' : ''}>Viewer</option>
                                    <option value="Editor" ${member.role === 'Editor' ? 'selected' : ''}>Editor</option>
                                    <option value="Admin" ${member.role === 'Admin' ? 'selected' : ''}>Admin</option>
                                </select>
                            </td>
                            <td class="py-2 px-4">${member.status}</td>
                            <td class="py-2 px-4">
                                <button data-member-id="${member.id}" class="delete-member-btn text-red-600 hover:text-red-800 font-medium text-sm" ${permissions.canManageTeam ? '' : 'disabled'}>Hapus</button>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });

                document.querySelectorAll('.member-role-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const memberId = parseInt(e.target.dataset.memberId);
                        const newRole = e.target.value;
                        updateMemberRole(memberId, newRole);
                    });
                });

                document.querySelectorAll('.delete-member-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const memberId = parseInt(e.target.dataset.memberId);
                        const confirmed = await showCustomConfirm('Hapus Anggota', 'Apakah Anda yakin ingin menghapus anggota ini dari tim?');
                        if (confirmed) {
                            deleteMember(memberId);
                        }
                    });
                });
            }

            function inviteMember(name, email, role) {
                const generatedPassword = generateRandomPassword(); // Generate a random password
                const newMember = {
                    id: Date.now(),
                    name: name,
                    email: email,
                    password: generatedPassword, 
                    role: role,
                    status: 'Menunggu', 
                    color: generateRandomColor() 
                };
                teamMembers.push(newMember);
                saveSettings();
                renderTeamMembers();
                alert(`Undangan telah dikirim kepada ${name} (${email}).\nLink Login (simulasi): [Link Aplikasi Anda]\nKata Sandi: ${generatedPassword}\n\nMohon berikan kata sandi ini kepada anggota tim secara aman.`);
            }

            function updateMemberRole(id, newRole) {
                const memberIndex = teamMembers.findIndex(m => m.id === id);
                if (memberIndex !== -1) {
                    teamMembers[memberIndex].role = newRole;
                    saveSettings();
                    renderTeamMembers();
                }
            }

            function deleteMember(id) {
                teamMembers = teamMembers.filter(m => m.id !== id);
                saveSettings();
                renderTeamMembers();
            }

            // --- SETUP & EVENT LISTENERS ---
            function populateSelects() {
                const platformSelects = [
                    { el: document.getElementById('filter-platform'), data: PLATFORMS, placeholder: 'Semua Platform', all: true }
                ];
                platformSelects.forEach(s => {
                    s.el.innerHTML = s.all ? `<option value="all">${s.placeholder}</option>` : `<option value="" disabled selected>${s.placeholder}</option>`;
                    s.data.forEach(p => s.el.innerHTML += `<option value="${p.id}">${p.name}</option>`);
                });

                const statusSelects = [
                     { el: document.getElementById('filter-status'), placeholder: 'Semua Status', all: true },
                     { el: document.getElementById('content-status'), placeholder: 'Pilih Status' }
                ];
                statusSelects.forEach(s => {
                    s.el.innerHTML = s.all ? `<option value="all">${s.placeholder}</option>` : `<option value="" disabled selected>${s.placeholder}</option>`;
                    Object.keys(STATUSES).forEach(key => s.el.innerHTML += `<option value="${key}">${STATUSES[key].name}</option>`);
                });
            }

            function populatePlatformCheckboxes() {
                const container = document.getElementById('content-platform-checkboxes');
                container.innerHTML = '';
                PLATFORMS.forEach(p => {
                    const checkboxHtml = `
                        <div class="flex items-center">
                            <input type="checkbox" id="platform-${p.id}" name="platform" value="${p.id}" class="w-4 h-4 text-indigo-600 border-stone-300 rounded focus:ring-indigo-500">
                            <label for="platform-${p.id}" class="ml-2 text-sm font-medium text-stone-700">${p.name}</label>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', checkboxHtml);
                });
            }

            function populateReportDateFilters() {
                const monthSelect = document.getElementById('report-month');
                const yearSelect = document.getElementById('report-year');
                const platformFilterSelect = document.getElementById('report-platform-filter'); // New element

                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth();

                for (let i = 0; i < 12; i++) {
                    const monthName = new Date(0, i).toLocaleString('id-ID', { month: 'long' });
                    monthSelect.innerHTML += `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${monthName}</option>`;
                }
                for (let y = currentYear + 1; y >= currentYear - 5; y--) { // Added +1 for future year planning
                    yearSelect.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`;
                }

                // Populate new platform filter for report
                platformFilterSelect.innerHTML = `<option value="all">Semua Platform</option>`;
                PLATFORMS.forEach(p => {
                    platformFilterSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`; 
                });
            }
            
            function setupEventListeners() {
                // Login Form Submission
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = loginEmailInput.value;
                    const password = loginPasswordInput.value;

                    // Re-load team members from localStorage just in case it was updated by signup
                    const savedTeamMembers = localStorage.getItem('cpiTeamMembers');
                    if (savedTeamMembers) {
                        teamMembers = JSON.parse(savedTeamMembers);
                    }

                    console.log('Attempting login with:');
                    console.log('Email:', email);
                    console.log('Password:', password);
                    console.log('Available team members:', JSON.stringify(teamMembers));

                    const user = teamMembers.find(member => member.email === email && member.password === password);

                    if (user) {
                        console.log('Login successful for user:', user);
                        appSettings.account.name = user.name;
                        appSettings.account.email = user.email;
                        appSettings.account.role = user.role;
                        localStorage.setItem('loggedInUserEmail', user.email); // Simulate session
                        loginErrorMessage.classList.add('hidden');
                        showApp();
                    } else {
                        loginErrorMessage.classList.remove('hidden');
                        console.log('Login failed: User not found or incorrect credentials.');
                    }
                });

                // Signup Form Submission (Simulated)
                signupForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    console.log('Signup form submitted.'); // Added for debugging
                    const name = document.getElementById('signup-name').value;
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;

                    // Always load the latest teamMembers from storage before checking
                    const currentTeamMembers = JSON.parse(localStorage.getItem('cpiTeamMembers') || '[]');
                    const adminExists = currentTeamMembers.some(member => member.role === 'Admin');
                    const emailAlreadyRegistered = currentTeamMembers.some(member => member.email === email);

                    if (email === INITIAL_ADMIN_EMAIL) {
                        if (emailAlreadyRegistered) {
                             alert('Akun dengan email ini sudah terdaftar. Silakan login.');
                             showLoginForm();
                             return;
                        }
                        if (!adminExists) {
                            const newAdmin = {
                                id: Date.now(),
                                name: name,
                                email: email,
                                password: password,
                                role: 'Admin',
                                status: 'Aktif',
                                color: generateRandomColor()
                            };
                            teamMembers.push(newAdmin); // Update the in-memory array
                            saveSettings(); // Save the updated array to localStorage
                            alert(`Selamat! Akun admin utama Anda berhasil dibuat. Silakan login dengan email dan kata sandi yang Anda daftarkan.`);
                            showLoginForm(); // Switch back to login form
                        } else {
                            alert('Admin utama sudah terdaftar. Pendaftaran dengan email ini hanya untuk admin utama pertama kali.');
                        }
                    } else {
                        alert('Pendaftaran akun baru tidak diizinkan untuk email ini. Aplikasi ini hanya mengizinkan pendaftaran admin utama pertama kali menggunakan email khusus. Untuk mencoba aplikasi, silakan login dengan akun demo yang tersedia:\n\nAdmin: admin@example.com / admin123\nEditor: siti@example.com / siti123\nViewer: joko@example.com / joko123');
                    }
                });

                // Login/Signup Tab Switching
                loginTabBtn.addEventListener('click', showLoginForm);
                signupTabBtn.addEventListener('click', showSignupForm);
                loginLinkFromSignup.addEventListener('click', (e) => {
                    e.preventDefault();
                    showLoginForm();
                });


                // Logout Button
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('loggedInUserEmail'); // Clear session
                    appSettings.account.name = '';
                    appSettings.account.email = '';
                    appSettings.account.role = '';
                    showLoginPage();
                    loginEmailInput.value = ''; // Clear login form
                    loginPasswordInput.value = '';
                });

                // Simulated Forgot Password link
                document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    alert('Fitur lupa kata sandi disimulasikan. Silakan hubungi admin untuk reset.');
                });


                navCalendar.addEventListener('click', () => { activeView = 'calendar'; updateView(); });
                navReport.addEventListener('click', () => { activeView = 'report'; updateView(); });
                navSettings.addEventListener('click', () => { activeView = 'settings'; updateView(); });

                document.getElementById('prev-month-cal').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); updateCalendarView(); renderInspiration(); });
                document.getElementById('next-month-cal').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); updateCalendarView(); renderInspiration(); });
                
                document.getElementById('report-month').addEventListener('change', renderReport);
                document.getElementById('report-year').addEventListener('change', renderReport);
                document.getElementById('report-platform-filter').addEventListener('change', renderReport); // New event listener for platform filter
                
                document.getElementById('filter-platform').addEventListener('change', updateCalendarView);
                document.getElementById('filter-status').addEventListener('change', updateCalendarView);

                viewCalendarGridBtn.addEventListener('click', () => { activeCalendarSubView = 'grid'; updateCalendarView(); });
                viewCalendarListBtn.addEventListener('click', () => { activeCalendarSubView = 'list'; updateCalendarView(); });
                
                addNewContentBtn.addEventListener('click', () => {
                    const permissions = ROLES[appSettings.account.role];
                    if (permissions.canAdd) {
                        openModal(new Date().toISOString().split('T')[0]);
                    } else {
                        alert('Anda tidak memiliki izin untuk menambah konten baru.');
                    }
                });
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
                
                contentForm.addEventListener('submit', handleFormSubmit);

                document.getElementById('content-status').addEventListener('change', (e) => {
                    if (e.target.value === 'terpublikasi') {
                        performanceMetricsSection.classList.remove('hidden');
                        const selectedPlatforms = Array.from(document.querySelectorAll('#content-platform-checkboxes input[type="checkbox"]:checked'))
                                                    .map(checkbox => checkbox.value);
                        // Get current content to pre-fill metrics if editing
                        const currentContentId = document.getElementById('content-id').value;
                        const currentContent = currentContentId ? contentData.find(item => item.id == currentContentId) : null;
                        renderPlatformMetricsInputs(selectedPlatforms, currentContent ? currentContent.metrics : {});
                    } else {
                        performanceMetricsSection.classList.add('hidden');
                        platformMetricsInputs.innerHTML = ''; // Clear inputs when not published
                    }
                });

                // Event listener for platform checkboxes to dynamically update metric inputs
                document.getElementById('content-platform-checkboxes').addEventListener('change', (e) => {
                    if (document.getElementById('content-status').value === 'terpublikasi') {
                        const selectedPlatforms = Array.from(document.querySelectorAll('#content-platform-checkboxes input[type="checkbox"]:checked'))
                                                    .map(checkbox => checkbox.value);
                        const currentContentId = document.getElementById('content-id').value;
                        const currentContent = currentContentId ? contentData.find(item => item.id == currentContentId) : null;
                        renderPlatformMetricsInputs(selectedPlatforms, currentContent ? currentContent.metrics : {});
                    }
                });
                
                deleteContentBtn.addEventListener('click', async () => {
                    const permissions = ROLES[appSettings.account.role];
                    if (!permissions.canDelete) {
                        alert('Anda tidak memiliki izin untuk menghapus konten.');
                        return;
                    }
                    const id = document.getElementById('content-id').value;
                    const confirmed = await showCustomConfirm('Hapus Konten', 'Apakah Anda yakin ingin menghapus konten ini?');
                    if (confirmed) {
                        contentData = contentData.filter(item => item.id != id);
                        saveSettings();
                        updateView();
                        closeModal();
                    }
                });

                copyContentBtn.addEventListener('click', copyContent);
                printContentBtn.addEventListener('click', printContent);
                exportPdfContentBtn.addEventListener('click', exportPdfContent);

                document.getElementById('print-report-btn').addEventListener('click', printReport);
                document.getElementById('export-pdf-report-btn').addEventListener('click', exportPdfReport);

                // Simulated Google Drive upload / Link save
                uploadToFileBtn.addEventListener('click', () => {
                    const files = document.getElementById('content-file-upload').files;
                    const link = document.getElementById('content-link-upload').value.trim();
                    
                    uploadedFilesList.innerHTML = ''; // Clear previous list

                    if (files.length === 0 && link === '') {
                        alert('Silakan pilih file atau masukkan link untuk diunggah/disimpan terlebih dahulu.');
                        return;
                    }

                    if (files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            uploadedFilesList.insertAdjacentHTML('beforeend', `<p class="text-xs text-stone-600">✅ Simulasi unggah file: ${files[i].name}</p>`);
                        }
                    }
                    if (link !== '') {
                        uploadedFilesList.insertAdjacentHTML('beforeend', `<p class="text-xs text-stone-600">✅ Simulasi simpan link: <a href="${link}" target="_blank" class="text-indigo-600 hover:underline">${link}</a></p>`);
                    }
                    alert('Simulasi unggah file dan/atau simpan link berhasil! (Fitur unggah ke Google Drive yang sebenarnya memerlukan integrasi backend dan otentikasi OAuth, yang tidak dapat diimplementasikan dalam satu file HTML ini.)');
                });


                // Settings Navigation
                Object.keys(settingsNavButtons).forEach(key => {
                    settingsNavButtons[key].addEventListener('click', () => {
                        activeSettingsPane = key;
                        renderSettings();
                    });
                });

                // Settings Forms
                document.getElementById('account-settings-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    appSettings.account.name = document.getElementById('account-name').value;
                    // Password change logic would go here (not implemented for this demo)

                    const profilePicFile = document.getElementById('profile-picture-upload').files[0];
                    if (profilePicFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            appSettings.account.profilePicture = e.target.result; // Store base64
                            saveSettings();
                            updateAccountSettingsForm(); // Update preview and name
                            alert('Pengaturan akun berhasil disimpan!');
                        };
                        reader.readAsDataURL(profilePicFile);
                    } else {
                        saveSettings();
                        updateAccountSettingsForm(); // Update name
                        alert('Pengaturan akun berhasil disimpan!');
                    }
                });

                // Profile Picture Upload Preview
                document.getElementById('profile-picture-upload').addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('profile-picture-preview').src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        document.getElementById('profile-picture-preview').src = appSettings.account.profilePicture; // Revert to current saved PP
                    }
                });

                // Company Settings Form Submit (with logo handling)
                document.getElementById('company-settings-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    appSettings.companyName = document.getElementById('company-name').value;

                    const logoFile = document.getElementById('company-logo-upload').files[0];
                    if (logoFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            appSettings.companyLogo = e.target.result; // Store base64
                            saveSettings();
                            updateCompanyNameDisplay();
                            alert('Pengaturan perusahaan dan logo berhasil disimpan!');
                        };
                        reader.readAsDataURL(logoFile);
                    } else {
                        saveSettings();
                        updateCompanyNameDisplay();
                        alert('Pengaturan perusahaan berhasil disimpan!');
                    }
                });

                // Company Logo Upload Preview
                document.getElementById('company-logo-upload').addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('company-logo-preview').src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        document.getElementById('company-logo-preview').src = appSettings.companyLogo; // Revert to current saved logo
                    }
                });


                document.getElementById('invite-member-btn').addEventListener('click', () => {
                    const permissions = ROLES[appSettings.account.role];
                    if (permissions.canManageTeam) {
                        inviteMemberModal.classList.remove('hidden');
                        inviteMemberModal.classList.add('flex');
                        inviteMemberForm.reset();
                    } else {
                        alert('Anda tidak memiliki izin untuk mengundang anggota baru.');
                    }
                });
                closeInviteModalBtn.addEventListener('click', () => {
                    inviteMemberModal.classList.add('hidden');
                    inviteMemberModal.classList.remove('flex');
                });
                inviteMemberModal.addEventListener('click', (e) => {
                    if (e.target === inviteMemberModal) {
                        inviteMemberModal.classList.add('hidden');
                        inviteMemberModal.classList.remove('flex');
                    }
                });
                inviteMemberForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('invite-name').value;
                    const email = document.getElementById('invite-email').value;
                    const role = document.getElementById('invite-role').value;
                    inviteMember(name, email, role);
                    inviteMemberModal.classList.add('hidden');
                    inviteMemberModal.classList.remove('flex');
                });

                darkModeToggle.addEventListener('change', (e) => {
                    applyTheme(e.target.checked ? 'dark' : 'light');
                });
            }

            // --- INITIALIZATION ---
            initializeApp();
        });
    </script>
</body>
</html>
